import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Calendar, Ticket, Wallet, ClipboardList, MapPin, Plane, Coffee, Plus, Car, 
  Camera, BedDouble, ShoppingBag, Sun, CloudRain, CloudSun, MoreVertical, 
  X, Navigation, GripVertical, Clock, Info, Trash2, Edit3, DollarSign, 
  JapaneseYen, Settings, Check, Utensils, Gift, Map, Loader2, Snowflake, 
  ExternalLink, CreditCard as CreditCardIcon, Coins, Train, UploadCloud,
  Cloud,
  CalendarDays,
  ArrowRight
} from 'lucide-react';
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';
// å¼•å…¥æˆ‘å€‘åšå¥½çš„é€£ç·šå·¥å…·
import { useRealtimeData } from './hooks/useRealtimeData';

// --- 1. Utils ---
function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// --- 2. Styles ---
const GlobalStyles = () => (
  <style>{`
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap');
    
    :root {
      --bg-journal: #F7F4EB;
      --color-primary: #88B04B;
      --color-accent: #FF8C42;
      --color-text: #4A4A4A;
      --color-dim: #E0E5D5;
    }

    body {
      font-family: "M PLUS Rounded 1c", sans-serif;
      background-color: #eee;
      color: var(--color-text);
      margin: 0;
    }

    .app-container {
      background-color: var(--bg-journal);
      background-image: radial-gradient(#D7D0C0 1.5px, transparent 1.5px);
      background-size: 24px 24px;
      min-height: 100vh;
    }

    .shadow-soft { box-shadow: 4px 4px 0px 0px #E0E5D5; }
    .shadow-soft-hover { box-shadow: 2px 2px 0px 0px #E0E5D5; }
    .shadow-ticket { box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05); }
    
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    .dragging { opacity: 0.5; border: 2px dashed #88B04B; }
    
    .input-journal {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.75rem;
      border: 2px solid #E0E5D5;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-journal:focus {
      border-color: #88B04B;
    }
  `}</style>
);

// --- 3. Types ---
type EventType = 'transport' | 'sightseeing' | 'food' | 'stay' | 'shopping' | 'flight' | 'other';
type BookingType = 'flight' | 'hotel' | 'rental';
type CurrencyType = 'JPY' | 'TWD';
type MustType = 'eat' | 'buy';
type PaymentMethodType = 'cash' | 'card' | 'suica';

interface TripEvent {
  id: string;
  time: string;
  title: string;
  location?: string;
  type: EventType;
  description?: string;
  price?: string;
  businessHours?: string;
  ticketPrice?: string;
  notes?: string;
  icon?: React.ElementType; 
}

interface BookingItem {
    id: string;
    type: BookingType;
    dateRange?: string;
    price?: string;
    flightNumber?: string;
    deptCode?: string;
    deptTime?: string;
    arrCode?: string;
    arrTime?: string;
    deptTerminal?: string;
    arrTerminal?: string;
    airline?: string;
    hotelName?: string;
    platform?: string;
    roomDetail?: string;
    company?: string;
    carModel?: string;
    pickUpLoc?: string;
    pickUpTime?: string;
    dropOffLoc?: string;
    dropOffTime?: string;
}

interface ExpenseItem {
    id: string;
    date: string;
    title: string;
    amount: number;
    currency: CurrencyType;
    category: EventType;
    paymentMethod: PaymentMethodType;
}

interface MustItem {
    id: string;
    type: MustType;
    area: string;
    name: string;
    location?: string;
    note: string;
    isCompleted: boolean;
}

interface HourlyWeather {
    time: string;
    temp: string;
    icon: React.ElementType;
    condition: string;
}

interface TripDay {
  id: string; // Add ID for Firestore
  date: string;
  dayNum: number;
  weekday: string;
  weekdayZh?: string;
  mainLocation: string;
  hourlyWeather: HourlyWeather[];
  events: TripEvent[];
}

// --- 4. Constants & Data (Defined FIRST) ---

const EVENT_TYPES: {value: EventType, label: string}[] = [
  { value: 'sightseeing', label: 'æ™¯é»' },
  { value: 'stay', label: 'ä½å®¿' },
  { value: 'food', label: 'ç¾é£Ÿ' },
  { value: 'shopping', label: 'è³¼ç‰©' },
  { value: 'flight', label: 'èˆªç­' },
  { value: 'transport', label: 'äº¤é€š' },
  { value: 'other', label: 'å…¶ä»–' },
];

const BOOKING_TYPES: {value: BookingType, label: string}[] = [
    { value: 'flight', label: 'èˆªç­' },
    { value: 'hotel', label: 'ä½å®¿' },
    { value: 'rental', label: 'ç§Ÿè»Š' },
];

const PAYMENT_METHODS: {value: PaymentMethodType, label: string, icon: any, color: string}[] = [
    { value: 'cash', label: 'ç¾é‡‘', icon: Coins, color: 'text-yellow-600 bg-yellow-50' },
    { value: 'suica', label: 'è¥¿ç“œå¡', icon: Train, color: 'text-green-600 bg-green-50' },
    { value: 'card', label: 'ä¿¡ç”¨å¡', icon: CreditCardIcon, color: 'text-blue-600 bg-blue-50' },
];

const MUST_AREAS = ['åå¤å±‹', 'æ¾é˜ª', 'ä¼Šå‹¢', 'é³¥ç¾½', 'å¿—æ‘©', 'å¸¸æ»‘', 'å…¶ä»–'];

const TYPE_STYLES: Record<EventType, { color: string; bg: string; label: string; icon: any }> = {
  flight: { color: '#0EA5E9', bg: '#E0F2FE', label: 'èˆªç­', icon: Plane },
  transport: { color: '#3B82F6', bg: '#EFF6FF', label: 'äº¤é€š', icon: Car },
  sightseeing: { color: '#F59E0B', bg: '#FFFBEB', label: 'æ™¯é»', icon: Camera },
  food: { color: '#EC4899', bg: '#FDF2F8', label: 'ç¾é£Ÿ', icon: Coffee },
  stay: { color: '#8B5CF6', bg: '#F5F3FF', label: 'ä½å®¿', icon: BedDouble },
  shopping: { color: '#10B981', bg: '#ECFDF5', label: 'è³¼ç‰©', icon: ShoppingBag },
  other: { color: '#6B7280', bg: '#F3F4F6', label: 'å…¶ä»–', icon: Info },
};

// Weather Logic
const CITY_WEATHER_PROFILES: Record<string, { baseTemp: number, conditions: string[] }> = {
    'æ´¥å¸‚': { baseTemp: 6, conditions: ['Sunny', 'Cloudy'] },
    'æ¾é˜ªå¸‚': { baseTemp: 7, conditions: ['Sunny', 'Sunny'] },
    'å¿—æ‘©å¸‚': { baseTemp: 9, conditions: ['Sunny', 'Cloudy'] }, 
    'ä¼Šå‹¢å¸‚': { baseTemp: 6, conditions: ['Cloudy', 'Rainy'] },
    'åå¤å±‹å¸‚': { baseTemp: 4, conditions: ['Cloudy', 'Snowy'] }, 
    'å¸¸æ»‘å¸‚': { baseTemp: 7, conditions: ['Sunny', 'Windy'] },
};

const getWeatherIcon = (condition: string) => {
    switch (condition) {
        case 'Sunny': return Sun;
        case 'Cloudy': return CloudSun;
        case 'Rainy': return CloudRain;
        case 'Snowy': return Snowflake;
        case 'Windy': return Cloud; 
        default: return Sun;
    }
};

const getConditionText = (condition: string) => {
    switch (condition) {
        case 'Sunny': return 'æ™´æœ—';
        case 'Cloudy': return 'å¤šé›²';
        case 'Rainy': return 'å°é›¨';
        case 'Snowy': return 'å°é›ª';
        case 'Windy': return 'å¼·é¢¨';
        default: return 'æ™´';
    }
};

const fetchWeatherForLocation = async (location: string): Promise<HourlyWeather[]> => {
    await new Promise(resolve => setTimeout(resolve, 600));

    const profile = CITY_WEATHER_PROFILES[location] || { baseTemp: 8, conditions: ['Sunny'] };
    const data: HourlyWeather[] = [];
    
    for (let i = 9; i <= 18; i++) {
        let hourTemp = profile.baseTemp;
        if (i <= 11) hourTemp += (i - 9); 
        else if (i <= 14) hourTemp += 3; 
        else hourTemp += 3 - (i - 14); 

        hourTemp += Math.floor(Math.random() * 2);
        const cond = profile.conditions[Math.floor(Math.random() * profile.conditions.length)];

        data.push({
            time: `${i.toString().padStart(2, '0')}:00`,
            temp: `${hourTemp}Â°`,
            icon: getWeatherIcon(cond),
            condition: getConditionText(cond)
        });
    }
    return data;
};

// **MOVED UP**: Defined MOCK_HOURLY_WEATHER before usage
const MOCK_HOURLY_WEATHER: HourlyWeather[] = [
    { time: '09:00', temp: '8Â°', icon: Sun, condition: 'æ™´' },
    { time: '10:00', temp: '9Â°', icon: CloudSun, condition: 'å¤šé›²' },
    { time: '11:00', temp: '11Â°', icon: Cloud, condition: 'é™°' },
    { time: '12:00', temp: '12Â°', icon: CloudSun, condition: 'å¤šé›²' },
    { time: '13:00', temp: '13Â°', icon: Sun, condition: 'æ™´' },
    { time: '14:00', temp: '12Â°', icon: Sun, condition: 'æ™´' },
    { time: '15:00', temp: '11Â°', icon: CloudRain, condition: 'å°é›¨' },
    { time: '16:00', temp: '10Â°', icon: Cloud, condition: 'é™°' },
];

const INITIAL_TRIP_DATA: TripDay[] = [
  {
    id: 'day-1',
    date: '2026-01-14',
    dayNum: 1,
    weekday: 'Wed',
    weekdayZh: 'é€±ä¸‰',
    mainLocation: 'æ´¥å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
      { id: '1-1', time: '15:50', title: 'JL8670 é£›å¾€åå¤å±‹', location: 'æ¡ƒåœ’æ©Ÿå ´ T2', type: 'flight', description: 'æŠµé”æ™‚é–“ 19:25 ä¸­éƒ¨åœ‹éš› T1', notes: 'è¨˜å¾—é è¾¦ç™»æ©Ÿ' },
      { id: '1-2', time: '20:00', title: 'å–è»Š (æ—¥ç”¢ç§Ÿè»Š)', location: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´åº—', type: 'transport', description: 'é ç´„ç·¨è™Ÿ: RC2246... (Serena e-POWER)', price: 'Â¥88,902' },
      { id: '1-3', time: '21:30', title: 'å…¥ä½é£¯åº—', location: 'Hotel Castle Inn Tsu', type: 'stay', description: 'å«æ—©é¤å…©é–“æˆ¿', price: 'Â¥15,496', businessHours: 'Check-in: 15:00' }
    ]
  },
  {
    id: 'day-2',
    date: '2026-01-15',
    dayNum: 2,
    weekday: 'Thu',
    weekdayZh: 'é€±å››',
    mainLocation: 'æ¾é˜ªå¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
      { id: '2-1', time: '09:00', title: 'å‰å¾€æ¾é˜ª', location: 'ç´„ 1 å°æ™‚è»Šç¨‹', type: 'transport', description: 'åœè»Šï¼šã‚ˆã„ã»ãƒ¢ãƒ¼ãƒ«ç¬¬6é§è»Šå ´' },
      { id: '2-2', time: '10:00', title: 'æ¾é˜ªè§€å…‰äº¤æµä¸­å¿ƒ', location: 'è±ªå•†ä¹‹è¡—', type: 'sightseeing', businessHours: '09:00-18:00', notes: '2æ¨“æœ‰æ”¾æ˜ å®¤(è‹±æ–‡å­—å¹•)' },
      { id: '2-2a', time: '10:45', title: 'æ¾é˜ªæœ¨æ£‰æ‰‹ç¹”ä¸­å¿ƒ', location: 'æ¾é˜ªå¸‚', type: 'sightseeing', description: 'è—è‰²æ¢ç´‹æœ¨æ£‰å¸ƒåŒ¹ã€æ‰‹ç¹”é«”é©—' },
      { id: '2-2b', time: '11:15', title: 'èˆŠå°æ´¥æ¸…å·¦è¡›é–€å®¶', location: 'æ¾é˜ªå¸‚æœ¬ç”º', type: 'sightseeing', description: 'ç´™èˆ‡æœ¨æ£‰å¯Œå•†å®…é‚¸', ticketPrice: 'Â¥200' },
      { id: '2-2c', time: '11:45', title: 'èˆŠé•·è°·å·æ²»éƒå…µè¡›å®¶', location: 'æ¾é˜ªå¸‚', type: 'sightseeing', description: 'è¿´éŠå¼åº­åœ’ã€å¤§åˆ¤å°åˆ¤å±•ç¤º' },
      { id: '2-3', time: '12:15', title: 'æ¾å‚åŸè·¡', location: 'æ¾é˜ªå¸‚', type: 'sightseeing', description: 'è’²ç”Ÿæ°éƒ·å»ºé€ ã€å£¯è§€çŸ³å£' },
      { id: '2-3a', time: '12:45', title: 'å¾¡åŸç•ªå±‹æ•·', location: 'æ¾å‚åŸè·¡æ—', type: 'sightseeing', description: 'ç´€å·è—©å£«æˆ¿èˆã€é‡è¦æ–‡åŒ–è²¡' },
      { id: '2-4', time: '13:00', title: 'ä¸€å‡ç“¶ æœ¬åº—', location: 'æ¾é˜ªå¸‚å—ç”º', type: 'food', description: 'æ¾é˜ªç‰›è¿´è½‰ç‡’è‚‰', businessHours: '11:00-21:30', notes: 'å¿…é»ç‰›æ’éƒ¨ä½' },
      { id: '2-4a', time: '14:30', title: 'èŒ¶éŠè†³ èŒ¶é‡', location: 'æ¾é˜ªå¸‚æ–°ç”º', type: 'food', description: 'æ·±è’¸ç…èŒ¶ã€æ—¥å¼ç©ºé–“' },
      { id: '2-5', time: '15:30', title: 'æ©«å±±å±•æœ›å°', location: 'å¿—æ‘©å¸‚', type: 'sightseeing', description: 'çœºæœ›è‹±è™ç£çµ•æ™¯ã€éŠå®¢ä¸­å¿ƒ' },
      { id: '2-6', time: '16:30', title: 'å¤§ç‹å´ç‡ˆå¡”', location: 'å¿—æ‘©åŠå³¶æ±å—ç«¯', type: 'sightseeing', description: 'ç™»å¡”åƒè§€ã€å…«å¹¡å±±å…¬åœ’çœºæœ›', notes: 'çœ‹æ™‚é–“æ±ºå®š' },
      { id: '2-7', time: '17:30', title: 'å…¥ä½ï¼šå¿—æ‘©è§€å…‰é£¯åº—', location: 'The Bay Suite', type: 'stay', price: 'Â¥92,640' }
    ]
  },
  {
    id: 'day-3',
    date: '2026-01-16',
    dayNum: 3,
    weekday: 'Fri',
    weekdayZh: 'é€±äº”',
    mainLocation: 'å¿—æ‘©å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '3-0', time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'å¿—æ‘©è§€å…‰é£¯åº—', type: 'food' },
        { id: '3-1', time: '09:00', title: 'é£¯åº—æ­·å²å°è¦½', location: 'å¿—æ‘©è§€å…‰é£¯åº—', type: 'sightseeing', description: 'ç´„40åˆ†é˜' },
        { id: '3-2', time: '11:15', title: 'è‹±è™ç£éŠèˆ¹', location: 'Marine Cab', type: 'sightseeing', ticketPrice: 'Â¥1,500', description: 'ç´„45åˆ†é˜' },
        { id: '3-2a', time: '12:15', title: 'æµ·å¥³æ–‡åŒ–è³‡æ–™é¤¨', location: 'ç›¸å·®ç”º', type: 'sightseeing', description: 'å…è²»å…¥é¤¨ã€é®‘é­šæ¡é›†é«”é©—æ¨¡å‹' },
        { id: '3-2b', time: '12:45', title: 'ç¥æ˜ç¥ç¤¾ (çŸ³ç¥ã•ã‚“)', location: 'ç›¸å·®ç”º', type: 'sightseeing', description: 'å¥³æ€§è¨±é¡˜éˆé©—ã€Doman Semanåœ–é¨°' },
        { id: '3-3', time: '13:15', title: 'æµ·å¥³å°å±‹ (å…«å¹¡ç¶)', location: 'ç›¸å·®ç”º', type: 'food', description: 'ç¾çƒ¤æµ·é®® + æµ·å¥³è¡¨æ¼”', price: 'Â¥31,900' },
        { id: '3-4', time: '15:00', title: 'çç åšç‰©é¤¨', location: 'å¾¡æœ¨æœ¬çœŸç å³¶', type: 'sightseeing', description: 'çç é¤Šæ®–æ­·å²ã€é£¾å“å±•ç¤º' },
        { id: '3-5', time: '15:30', title: 'æµ·å¥³è¡¨æ¼”', location: 'å¾¡æœ¨æœ¬çœŸç å³¶', type: 'sightseeing', description: 'è§€çœ‹æœ€å¾Œä¸€å ´è¡¨æ¼”' },
        { id: '3-6', time: '17:00', title: 'å…¥ä½ï¼šé³¥ç¾½åœ‹éš›é£¯åº—', location: 'æ½®è·¯äº­', type: 'stay', description: 'å…©æ™šä½å®¿', price: 'Â¥142,662' }
    ]
  },
  {
    id: 'day-4',
    date: '2026-01-17',
    dayNum: 4,
    weekday: 'Sat',
    weekdayZh: 'é€±å…­',
    mainLocation: 'ä¼Šå‹¢å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '4-0', time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'æ½®è·¯äº­', type: 'food' },
        { id: '4-1', time: '10:00', title: 'ä¼Šå‹¢ç¥å®® (å¤–å®®)', location: 'è±å—å¤§ç¥å®®', type: 'sightseeing', notes: 'å·¦å´é€šè¡Œã€å…ˆç¥­å¤–å®®' },
        { id: '4-1a', time: '10:45', title: 'æœˆå¤œè¦‹å®®', location: 'å¤–å®®æ­¥è¡Œ5åˆ†', type: 'sightseeing', notes: 'çœ‹æ™‚é–“å¯å»å¯ä¸å»' },
        { id: '4-2', time: '11:30', title: 'ä¼Šå‹¢ç¥å®® (å…§å®®)', location: 'çš‡å¤§ç¥å®®', type: 'sightseeing', notes: 'å³å´é€šè¡Œã€äº”åéˆ´å·' },
        { id: '4-3', time: '13:00', title: 'æ‰˜ç¦æ©«ä¸', location: 'ä¼Šå‹¢ç¥å®®å‰', type: 'food', description: 'èµ¤ç¦æœ¬åº—ã€ä¼Šå‹¢çƒé¾éºµ(ãµãã™ã‘)ã€è±šæ¨å¯æ¨‚é¤…' },
        { id: '4-4', time: '14:30', title: 'ä¼Šå‹¢å¿—æ‘©å¤©ç©ºé“è·¯', location: 'æœç†Šå±±å±•æœ›å°', type: 'sightseeing', description: 'å¤©ç©ºéƒµç­’ã€è¶³æ¹¯' },
        { id: '4-5', time: '15:30', title: 'é‡‘å‰›è­‰å¯º', location: 'æœç†Šå±±', type: 'sightseeing', description: 'å®ˆè­·ä¼Šå‹¢ç¥å®®é¬¼é–€' },
        { id: '4-6', time: '16:30', title: 'å¤«å©¦å²©', location: 'äºŒè¦‹èˆˆç‰ç¥ç¤¾', type: 'sightseeing', description: 'äºŒè¦‹æµ¦æµ·å²¸' },
        { id: '4-7', time: '18:00', title: 'å›é£¯åº—', location: 'é³¥ç¾½åœ‹éš›é£¯åº—', type: 'stay' }
    ]
  },
  {
    id: 'day-5',
    date: '2026-01-18',
    dayNum: 5,
    weekday: 'Sun',
    weekdayZh: 'é€±æ—¥',
    mainLocation: 'åå¤å±‹å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '5-0', time: '07:00', title: 'é£¯åº—æ—©é¤', location: 'æ½®è·¯äº­', type: 'food' },
        { id: '5-1', time: '09:00', title: 'é³¥ç¾½æ°´æ—é¤¨', location: 'é³¥ç¾½å¸‚', type: 'sightseeing', description: 'é£¼é¤Šç¨®é¡æ—¥æœ¬ç¬¬ä¸€', notes: 'çœ‹æ™‚é–“å¯å»å¯ä¸å»' },
        { id: '5-2', time: '13:00', title: 'è±ç”°ç”¢æ¥­æŠ€è¡“ç´€å¿µé¤¨', location: 'åå¤å±‹å¸‚è¥¿å€', type: 'sightseeing', businessHours: '09:30-17:00', ticketPrice: 'Â¥500' },
        { id: '5-3', time: '17:00', title: 'Comfort Hotel', location: 'åå¤å±‹é‡‘å±±', type: 'stay', description: 'åéµå”å•†åœè»Šå ´(å±‹é ‚)', notes: 'åœè»Šè²»Â¥1200/æ™š' },
        { id: '5-4', time: '18:00', title: 'å¸‚å€æ¼«æ­¥', location: 'åå¤å±‹', type: 'other', description: 'æ”¾å®Œè¡Œæå¾Œå¤–å‡º' }
    ]
  },
  {
    id: 'day-6',
    date: '2026-01-19',
    dayNum: 6,
    weekday: 'Mon',
    weekdayZh: 'é€±ä¸€',
    mainLocation: 'åå¤å±‹å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '6-1', time: '09:00', title: 'åå¤å±‹æ—©é¤', location: 'Komeda Coffee', type: 'food', description: 'é»é£²æ–™é€åå¸' },
        { id: '6-2', time: '10:30', title: 'åå¤å±‹åŸ', location: 'ä¸­å€', type: 'sightseeing', description: 'é‡‘é¯±ã€æœ¬ä¸¸å¾¡æ®¿', ticketPrice: 'Â¥500' },
        { id: '6-2a', time: '12:30', title: 'å¤§é ˆè§€éŸ³å¯º', location: 'å¤§é ˆ', type: 'sightseeing', description: 'è–è§€éŸ³è©è–©ã€ç´…ç‡ˆç± ' },
        { id: '6-3', time: '13:00', title: 'å¤§é ˆå•†åº—è¡—', location: 'å¤§é ˆ', type: 'shopping', description: 'è³¼ç‰©å¤©å ‚' },
        { id: '6-4', time: '15:30', title: 'ç†±ç”°ç¥å®®', location: 'ç†±ç”°å€', type: 'sightseeing', description: 'ä¸‰ç¥å™¨è‰è–™åŠã€å¿ƒéˆä¹‹é„‰' }
    ]
  },
  {
    id: 'day-7',
    date: '2026-01-20',
    dayNum: 7,
    weekday: 'Tue',
    weekdayZh: 'é€±äºŒ',
    mainLocation: 'å¸¸æ»‘å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '7-1', time: '10:30', title: 'è§’ä¹…å…«ä¸å‘³å™Œ', location: 'å²¡å´å¸‚', type: 'sightseeing' },
        { id: '7-2', time: '13:00', title: 'è¥¿æ¢åœ’æŠ¹èŒ¶åšç‰©é¤¨', location: 'è¥¿å°¾å¸‚', type: 'sightseeing', notes: 'å·²é ç´„é«”é©—å°è¦½' },
        { id: '7-3', time: '15:00', title: 'å¸¸æ»‘å¸‚é™¶ç“·å™¨æœƒé¤¨', location: 'å¸¸æ»‘å¸‚', type: 'sightseeing', description: 'æ•£æ­¥é“èµ·é»ã€æ‹›è²¡è²“' },
        { id: '7-3a', time: '15:30', title: 'å®ˆè­·è²“Tokonyan', location: 'å¸¸æ»‘å¸‚', type: 'sightseeing', description: 'å·¨å‹æ‹›è²¡è²“ã€æ‹ç…§é»' },
        { id: '7-3b', time: '16:00', title: 'åœŸç®¡å‚', location: 'å¸¸æ»‘å¸‚', type: 'sightseeing', description: 'åœ°é¢é‹ªæ»¿ç‡’é…’ç“¶èˆ‡åœŸç®¡' },
        { id: '7-3c', time: '16:30', title: 'ç™»çª¯ & èé™¶åœ’', location: 'å¸¸æ»‘å¸‚', type: 'sightseeing' },
        { id: '7-4', time: '17:30', title: 'Aeon Mall å¸¸æ»‘', location: 'å¸¸æ»‘', type: 'shopping', description: 'æ™šé¤ã€è³¼ç‰©' },
        { id: '7-5', time: '20:00', title: 'æ­¸é‚„ç§Ÿè»Š', location: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´', type: 'transport' },
        { id: '7-6', time: '21:00', title: 'å…¥ä½é£¯åº—', location: 'Comfort Hotel Central Int\'l Airport', type: 'stay', price: 'Â¥2,752 (Points)' }
    ]
  },
  {
    id: 'day-8',
    date: '2026-01-21',
    dayNum: 8,
    weekday: 'Wed',
    weekdayZh: 'é€±ä¸‰',
    mainLocation: 'å¸¸æ»‘å¸‚',
    hourlyWeather: MOCK_HOURLY_WEATHER,
    events: [
        { id: '8-1', time: '10:00', title: 'æ©Ÿå ´å ±åˆ°', location: 'ä¸­éƒ¨åœ‹éš› T1', type: 'flight', description: 'æ‰˜é‹è¡Œæ' },
        { id: '8-1a', time: '11:00', title: 'Flight of Dreams', location: 'T2 èˆªå»ˆ', type: 'sightseeing', description: 'æ³¢éŸ³787å±•ç¤ºã€è¦ä»™è²ä¹‹é‡Œ' },
        { id: '8-2', time: '12:05', title: 'JL8671 è¿”å›å°åŒ—', location: 'æŠµé” 14:40', type: 'flight' }
    ]
  }
];

const INITIAL_BOOKINGS: BookingItem[] = [
    {
        id: 'b-1',
        type: 'flight',
        dateRange: '1/14',
        flightNumber: 'JL8670',
        deptCode: 'TPE', deptTime: '15:50', deptTerminal: 'æ¡ƒåœ’ T2',
        arrCode: 'NGO', arrTime: '19:25', arrTerminal: 'ä¸­éƒ¨ T1',
        airline: 'JAPAN AIRLINES'
    },
    {
        id: 'b-2',
        type: 'flight',
        dateRange: '1/21',
        flightNumber: 'JL8671',
        deptCode: 'NGO', deptTime: '12:05', deptTerminal: 'ä¸­éƒ¨ T1',
        arrCode: 'TPE', arrTime: '14:40', arrTerminal: 'æ¡ƒåœ’ T2',
        airline: 'JAPAN AIRLINES'
    },
    {
        id: 'b-3',
        type: 'hotel',
        dateRange: '1/14 - 15',
        hotelName: 'Hotel Castle Inn Tsu',
        platform: 'Booking.com',
        roomDetail: 'å«æ—©é¤ãƒ»å…©é–“å®¢æˆ¿',
        price: 'Â¥15,496'
    },
    {
        id: 'b-4',
        type: 'hotel',
        dateRange: '1/15 - 16',
        hotelName: 'Shima Kanko Hotel The Bay Suite',
        platform: 'ä¸€ä¼‘.com',
        roomDetail: 'å«æ—©é¤ãƒ»4å1å®¤',
        price: 'Â¥92,640'
    },
    {
        id: 'b-5',
        type: 'hotel',
        dateRange: '1/16 - 18',
        hotelName: 'Toba International Hotel Shiojitei',
        platform: 'ä¸€ä¼‘.com',
        roomDetail: 'å«æ—©é¤ãƒ»2å2å®¤',
        price: 'Â¥142,662'
    },
    {
        id: 'b-6',
        type: 'hotel',
        dateRange: '1/18 - 20',
        hotelName: 'Comfort Hotel Nagoya Kanayama',
        platform: 'Points',
        roomDetail: '32,000 pts',
        price: 'TWD 5,504'
    },
    {
        id: 'b-7',
        type: 'hotel',
        dateRange: '1/20 - 21',
        hotelName: 'Comfort Hotel Central Int\'l Airport',
        platform: 'Points',
        roomDetail: '16,000 pts',
        price: 'TWD 2,752'
    },
    {
        id: 'b-8',
        type: 'rental',
        company: 'æ—¥ç”£ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼',
        pickUpLoc: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´åº—',
        pickUpTime: '1/14 20:00',
        dropOffLoc: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´åº—',
        dropOffTime: '1/20 20:00',
        carModel: 'Serena e-POWER',
        price: 'Â¥88,902'
    }
];

const INITIAL_MUST_LIST: MustItem[] = [
    // Nagoya - Eat
    { id: 'm-1', type: 'eat', area: 'åå¤å±‹', name: 'çŸ¢å ´å‘³å™Œè±¬æ’', location: 'åéµç™¾è²¨åº—æœ¬é¤¨ 9F', note: 'åéµç™¾è²¨åº—ã€æ¦®åº—', isCompleted: false },
    { id: 'm-2', type: 'eat', area: 'åå¤å±‹', name: 'ç†±ç”°è“¬èŠè»’ é°»é­šé£¯', location: 'ç†±ç”°ç¥å®®æ—', note: 'ç†±ç”°ç¥å®®æ—ï¼Œéœ€æ’éšŠ', isCompleted: false },
    { id: 'm-3', type: 'eat', area: 'åå¤å±‹', name: 'ä¸–ç•Œä¹‹å±±å°‡æ‰‹ç¾½å…ˆ', location: 'åå¤å±‹å¸‚ä¸­å€æ¦®4-16-24', note: 'å¤¢å¹»é›ç¿…', isCompleted: false },
    { id: 'm-4', type: 'eat', area: 'åå¤å±‹', name: 'HARBS æ°´æœåƒå±¤', location: 'åå¤å±‹å¸‚ä¸­åŒºéŒ¦3-6-17', note: 'æ¦®æœ¬åº—', isCompleted: false },
    { id: 'm-4a', type: 'eat', area: 'åå¤å±‹', name: 'Konparu ç‚¸è¦ä¸‰æ˜æ²»', location: 'å¤§é ˆå•†åº—è¡—', note: 'è€ç‰Œå–«èŒ¶åº—', isCompleted: false },
    // Nagoya - Buy
    { id: 'm-5', type: 'buy', area: 'åå¤å±‹', name: 'é’æŸ³ç¸½æœ¬å®¶ é’è›™é¥…é ­', location: 'å¤§é ˆå•†åº—è¡—', note: 'å¯æ„›ä¼´æ‰‹ç¦®', isCompleted: false },
    { id: 'm-6', type: 'buy', area: 'å¸¸æ»‘', name: 'è¦ä»™è²ä¹‹é‡Œ', location: 'ä¸­éƒ¨åœ‹éš›æ©Ÿå ´ 4F', note: 'ä¸­éƒ¨æ©Ÿå ´/å¸¸æ»‘å¯è²·', isCompleted: false },
    { id: 'm-6a', type: 'buy', area: 'å¸¸æ»‘', name: 'å¸¸æ»‘ç‡’æ‹›è²¡è²“', location: 'å¸¸æ»‘å¸‚é™¶ç“·å™¨æœƒé¤¨', note: 'é™¶ç“·å™¨æ•£æ­¥é“', isCompleted: false },
    
    // Ise/Toba/Shima - Eat
    { id: 'm-7', type: 'eat', area: 'ä¼Šå‹¢', name: 'èµ¤ç¦é¤…', location: 'ä¼Šå‹¢ç¥å®® å†…å®®å‰', note: 'å…§å®®å‰æœ¬åº—ï¼Œç´…è±†éº»ç³¬', isCompleted: false },
    { id: 'm-8', type: 'eat', area: 'ä¼Šå‹¢', name: 'ä¼Šå‹¢çƒé¾éºµ', location: 'Fukusuke (ãµãã™ã‘)', note: 'æ‰˜ç¦æ©«ä¸å…§', isCompleted: false },
    { id: 'm-9', type: 'eat', area: 'ä¼Šå‹¢', name: 'è±šæ¨ å¯æ¨‚é¤…', location: 'æ‰˜ç¦æ©«ä¸å…§', note: 'å¿…åƒå°åƒ', isCompleted: false },
    { id: 'm-10', type: 'eat', area: 'æ¾é˜ª', name: 'ä¸€å‡ç“¶ æ¾é˜ªç‰›ç‡’è‚‰', location: 'æ¾é˜ªå¸‚å—ç”º232-3', note: 'è¿´è½‰ç‡’è‚‰', isCompleted: false },
    { id: 'm-11', type: 'eat', area: 'é³¥ç¾½', name: 'æµ·å¥³å°å±‹ ç¾çƒ¤æµ·é®®', location: 'é³¥ç¾½å¸‚ç›¸å·®ç”º819', note: 'Hachiman Kamado', isCompleted: false },
    // Ise/Toba/Shima - Buy
    { id: 'm-12', type: 'buy', area: 'ä¼Šå‹¢', name: 'ä¼Šå‹¢æœ¨æ£‰', location: 'ä¼Šå‹¢ç¥å®® å¤–å®®åƒé“', note: 'å£é‡‘åŒ…ã€æ‰‹å¸•', isCompleted: false },
    { id: 'm-13', type: 'buy', area: 'é³¥ç¾½', name: 'å¾¡æœ¨æœ¬çœŸç ', location: 'å¾¡æœ¨æœ¬çœŸç å³¶', note: 'çç é£¾å“', isCompleted: false },
];

// --- 5. Helpers ---
const parsePrice = (priceStr?: string): { amount: number, currency: CurrencyType } | null => {
    if (!priceStr) return null;
    
    if (priceStr.includes('TWD') || priceStr.includes('NT$')) {
        const num = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
        return { amount: isNaN(num) ? 0 : num, currency: 'TWD' };
    }
    
    const num = parseFloat(priceStr.replace(/[^0-9.]/g, ''));
    return { amount: isNaN(num) ? 0 : num, currency: 'JPY' };
};

const generateInitialExpenses = (): ExpenseItem[] => {
    return INITIAL_BOOKINGS.map(booking => {
        const priceData = parsePrice(booking.price);
        if (!priceData || priceData.amount === 0) return null;

        let title = '';
        let category: EventType = 'other';
        let date = '2026-01-14'; 
        let paymentMethod: PaymentMethodType = 'card';

        if (booking.pickUpTime) {
           const match = booking.pickUpTime.match(/(\d{1,2})\/(\d{1,2})/);
           if (match) date = `2026-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
           category = 'transport';
           title = `${booking.company} ç§Ÿè»Š`;
        } else if (booking.dateRange) {
           const match = booking.dateRange.match(/(\d{1,2})\/(\d{1,2})/);
           if (match) date = `2026-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
           
           if (booking.type === 'hotel') {
               category = 'stay';
               title = booking.hotelName || 'ä½å®¿è²»';
           } else if (booking.type === 'flight') {
               category = 'flight';
               title = `${booking.airline} ${booking.flightNumber}`;
           }
        }

        return {
            id: `exp-${booking.id}`,
            date,
            title,
            amount: priceData.amount,
            currency: priceData.currency,
            category,
            paymentMethod
        };
    }).filter((item): item is ExpenseItem => item !== null);
};

// --- 6. UI Components ---

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'accent' | 'outline' | 'ghost' | 'danger';
  size?: 'sm' | 'md' | 'lg' | 'icon';
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = 'primary', size = 'md', ...props }, ref) => {
    const variants = {
      primary: 'bg-[#88B04B] text-white border-2 border-[#88B04B] shadow-soft hover:translate-y-[1px] hover:shadow-soft-hover',
      accent: 'bg-[#FF8C42] text-white border-2 border-[#FF8C42] shadow-soft hover:translate-y-[1px] hover:shadow-soft-hover',
      outline: 'bg-white text-[#4A4A4A] border-2 border-[#E0E5D5] shadow-soft hover:translate-y-[1px] hover:shadow-soft-hover',
      ghost: 'bg-transparent text-[#4A4A4A] hover:bg-[#E0E5D5]/30',
      danger: 'bg-red-50 text-red-500 border-2 border-red-100 hover:bg-red-100',
    };

    const sizes = {
      sm: 'h-8 px-3 text-sm rounded-lg',
      md: 'h-11 px-5 text-base rounded-xl',
      lg: 'h-14 px-8 text-lg rounded-2xl',
      icon: 'h-11 w-11 p-0 flex items-center justify-center rounded-xl',
    };

    return (
      <button
        ref={ref}
        className={cn(
          'font-bold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:pointer-events-none flex items-center justify-center gap-2',
          variants[variant],
          sizes[size],
          className
        )}
        {...props}
      />
    );
  }
);
Button.displayName = "Button";

interface CardProps extends React.HTMLAttributes<HTMLDivElement> {
  noPadding?: boolean;
}

const Card = React.forwardRef<HTMLDivElement, CardProps>(
  ({ className, noPadding = false, children, ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          'bg-white rounded-[20px] border-2 border-[#E0E5D5] shadow-soft',
          noPadding ? 'p-0' : 'p-5',
          className
        )}
        {...props}
      >
        {children}
      </div>
    );
  }
);
Card.displayName = "Card";

const BottomNav = ({ activeTab, onTabChange }: { activeTab: string, onTabChange: (id: string) => void }) => {
  const navItems = [
    { id: 'schedule', icon: Calendar, label: 'è¡Œç¨‹' },
    { id: 'bookings', icon: Ticket, label: 'é è¨‚' },
    { id: 'expense', icon: Wallet, label: 'è¨˜å¸³' },
    { id: 'plan', icon: ShoppingBag, label: 'å¿…è²·å¿…åƒ' }, 
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-50 pb-safe pointer-events-none w-full md:max-w-md md:mx-auto">
      <div className="absolute inset-0 bg-[#F7F4EB]/90 backdrop-blur-md border-t-2 border-[#E0E5D5] pointer-events-auto" />
      <div className="relative flex justify-around items-end h-[80px] pb-4 px-2 pointer-events-auto">
        {navItems.map((item) => {
          const isActive = activeTab === item.id;
          return (
            <button
              key={item.id}
              onClick={() => onTabChange(item.id)}
              className={cn(
                "flex flex-col items-center justify-center w-16 gap-1 transition-all duration-300",
                isActive ? "text-[#88B04B] -translate-y-1" : "text-[#8D6E63] opacity-60 hover:opacity-100"
              )}
            >
              <item.icon 
                size={isActive ? 26 : 24} 
                strokeWidth={isActive ? 2.5 : 2}
                className={cn("transition-all", isActive && "fill-[#88B04B]/10")}
              />
              <span className="text-[10px] font-bold tracking-wide">{item.label}</span>
            </button>
          );
        })}
      </div>
    </nav>
  );
};

const Layout = ({ children, activeTab, onTabChange }: { children: React.ReactNode, activeTab: string, onTabChange: (id: string) => void }) => {
  return (
    <div className="app-container w-full md:max-w-md mx-auto relative flex flex-col shadow-2xl overflow-hidden border-x border-[#E0E5D5]">
      <GlobalStyles />
      <header className="sticky top-0 z-40 bg-[#F7F4EB]/90 backdrop-blur-sm px-5 py-4 flex justify-between items-center shadow-sm">
        <div className="flex flex-col">
          <span className="text-xs font-bold text-[#88B04B] tracking-wider uppercase">Japan Trip 2026</span>
          <h1 className="text-xl font-extrabold text-[#4A4A4A]">åå¤å±‹ãƒ»ä¼Šå‹¢ä¹‹æ—… ğŸ¯</h1>
        </div>
      </header>
      <main className="flex-1 px-5 pb-32 pt-2 space-y-6 overflow-y-auto scrollbar-hide">
        {children}
      </main>
      <BottomNav activeTab={activeTab} onTabChange={onTabChange} />
    </div>
  );
};

// --- 7. Modals ---

const TripModal = ({ 
    isOpen, 
    onClose, 
    onSave, 
    onDelete,
    initialData 
}: { 
    isOpen: boolean; 
    onClose: () => void; 
    onSave: (data: Partial<TripEvent>) => void;
    onDelete?: () => void;
    initialData?: TripEvent; 
}) => {
    if (!isOpen) return null;

    const [formData, setFormData] = useState<Partial<TripEvent>>({});
    const [isDeleting, setIsDeleting] = useState(false);

    useEffect(() => {
        setFormData({
            title: '',
            time: '10:00',
            type: 'sightseeing',
            location: '',
            businessHours: '',
            ticketPrice: '',
            notes: '',
            description: '',
            ...initialData
        });
        setIsDeleting(false);
    }, [initialData, isOpen]);

    const handleDelete = () => {
        if (isDeleting) {
            if (onDelete) onDelete();
        } else {
            setIsDeleting(true);
            setTimeout(() => setIsDeleting(false), 3000);
        }
    };

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose} />
            <Card className="w-full max-w-sm relative z-10 animate-bounce-slight" noPadding>
                <div className="p-4 border-b border-[#E0E5D5] flex justify-between items-center bg-[#F7F4EB] rounded-t-[20px]">
                    <h3 className="font-bold text-lg text-[#4A4A4A]">
                        {initialData ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'}
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-[#E0E5D5] rounded-full">
                        <X size={20} />
                    </button>
                </div>
                
                <div className="p-5 space-y-4 max-h-[60vh] overflow-y-auto">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åç¨±</label>
                        <input 
                            className="input-journal"
                            value={formData.title || ''}
                            onChange={e => setFormData({...formData, title: e.target.value})}
                            placeholder="ä¾‹å¦‚ï¼šåå¤å±‹åŸ"
                        />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">æ™‚é–“</label>
                            <input 
                                type="time"
                                className="input-journal"
                                value={formData.time || ''}
                                onChange={e => setFormData({...formData, time: e.target.value})}
                            />
                        </div>
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label>
                            <select 
                                className="input-journal bg-white"
                                value={formData.type || 'sightseeing'}
                                onChange={e => setFormData({...formData, type: e.target.value as EventType})}
                            >
                                {EVENT_TYPES.map(t => (
                                    <option key={t.value} value={t.value}>{t.label}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åœ°é»</label>
                        <input 
                            className="input-journal"
                            value={formData.location || ''}
                            onChange={e => setFormData({...formData, location: e.target.value})}
                            placeholder="è¼¸å…¥åœ°é»..."
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">ç‡Ÿæ¥­æ™‚é–“</label>
                            <input 
                                className="input-journal"
                                value={formData.businessHours || ''}
                                onChange={e => setFormData({...formData, businessHours: e.target.value})}
                            />
                        </div>
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">é–€ç¥¨/é ç®—</label>
                            <input 
                                className="input-journal"
                                value={formData.ticketPrice || ''}
                                onChange={e => setFormData({...formData, ticketPrice: e.target.value})}
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (é»ƒæ¡†å…§å®¹)</label>
                        <textarea 
                            className="input-journal h-20"
                            value={formData.description || ''}
                            onChange={e => setFormData({...formData, description: e.target.value})}
                            placeholder="é¡¯ç¤ºåœ¨å¡ç‰‡ä¸‹æ–¹çš„è©³ç´°èªªæ˜..."
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">ç‰¹è‰² & ç­†è¨˜</label>
                        <textarea 
                            className="input-journal h-20"
                            value={formData.notes || ''}
                            onChange={e => setFormData({...formData, notes: e.target.value})}
                            placeholder="ç§äººç­†è¨˜ã€æ³¨æ„äº‹é …..."
                        />
                    </div>
                </div>

                <div className="p-4 border-t border-[#E0E5D5] flex gap-3 bg-[#F7F4EB] rounded-b-[20px]">
                    {initialData && (
                        <Button 
                            variant={isDeleting ? "danger" : "outline"} 
                            className={cn("flex-1 transition-all", isDeleting && "bg-red-500 text-white border-red-500")}
                            onClick={handleDelete}
                        >
                            {isDeleting ? "ç¢ºå®šåˆªé™¤?" : <><Trash2 size={16} /> åˆªé™¤</>}
                        </Button>
                    )}
                    <Button className="flex-[2]" onClick={() => onSave(formData)}>
                        å„²å­˜
                    </Button>
                </div>
            </Card>
        </div>
    );
};

const BookingModal = ({ 
    isOpen, 
    onClose, 
    onSave, 
    onDelete,
    initialData 
}: { 
    isOpen: boolean; 
    onClose: () => void; 
    onSave: (data: Partial<BookingItem>) => void;
    onDelete?: () => void;
    initialData?: BookingItem; 
}) => {
    if (!isOpen) return null;

    const [formData, setFormData] = useState<Partial<BookingItem>>({});
    const [bookingType, setBookingType] = useState<BookingType>(initialData?.type || 'hotel');
    const [isDeleting, setIsDeleting] = useState(false);

    useEffect(() => {
        setFormData({ ...initialData });
        setBookingType(initialData?.type || 'hotel');
        setIsDeleting(false);
    }, [initialData, isOpen]);

    const handleDelete = () => {
        if (isDeleting) {
            if (onDelete) onDelete();
        } else {
            setIsDeleting(true);
            setTimeout(() => setIsDeleting(false), 3000);
        }
    };

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose} />
            <Card className="w-full max-w-sm relative z-10 animate-bounce-slight" noPadding>
                <div className="p-4 border-b border-[#E0E5D5] flex justify-between items-center bg-[#F7F4EB] rounded-t-[20px]">
                    <h3 className="font-bold text-lg text-[#4A4A4A]">
                        {initialData ? 'ç·¨è¼¯é è¨‚' : 'æ–°å¢é è¨‚'}
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-[#E0E5D5] rounded-full">
                        <X size={20} />
                    </button>
                </div>
                
                <div className="p-5 space-y-4 max-h-[60vh] overflow-y-auto">
                    {!initialData && (
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label>
                            <div className="flex gap-2">
                                {BOOKING_TYPES.map(t => (
                                    <button
                                        key={t.value}
                                        onClick={() => { setBookingType(t.value); setFormData({...formData, type: t.value}); }}
                                        className={cn(
                                            "flex-1 py-2 rounded-xl text-xs font-bold border-2 transition-all",
                                            bookingType === t.value 
                                                ? "border-[#88B04B] bg-[#88B04B]/10 text-[#88B04B]" 
                                                : "border-[#E0E5D5] bg-white text-gray-400"
                                        )}
                                    >
                                        {t.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {bookingType !== 'rental' && (
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ / å€é–“</label>
                            <input 
                                className="input-journal"
                                value={formData.dateRange || ''}
                                onChange={e => setFormData({...formData, dateRange: e.target.value})}
                                placeholder="ä¾‹å¦‚: 1/14 - 15"
                            />
                        </div>
                    )}
                    
                    {bookingType === 'flight' && (
                        <>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">èˆªç­ä»£è™Ÿ</label>
                                    <input className="input-journal" value={formData.flightNumber || ''} onChange={e => setFormData({...formData, flightNumber: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">èˆªç©ºå…¬å¸</label>
                                    <input className="input-journal" value={formData.airline || ''} onChange={e => setFormData({...formData, airline: e.target.value})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">èµ·é£› (ä»£ç¢¼/æ™‚é–“)</label>
                                    <input className="input-journal mb-2" value={formData.deptCode || ''} onChange={e => setFormData({...formData, deptCode: e.target.value})} placeholder="TPE"/>
                                    <input type="time" className="input-journal" value={formData.deptTime || ''} onChange={e => setFormData({...formData, deptTime: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">æŠµé” (ä»£ç¢¼/æ™‚é–“)</label>
                                    <input className="input-journal mb-2" value={formData.arrCode || ''} onChange={e => setFormData({...formData, arrCode: e.target.value})} placeholder="NGO"/>
                                    <input type="time" className="input-journal" value={formData.arrTime || ''} onChange={e => setFormData({...formData, arrTime: e.target.value})} />
                                </div>
                            </div>
                        </>
                    )}
                    {bookingType === 'hotel' && (
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">é£¯åº—åç¨±</label>
                            <input className="input-journal" value={formData.hotelName || ''} onChange={e => setFormData({...formData, hotelName: e.target.value})} />
                        </div>
                    )}
                    {bookingType === 'rental' && (
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">ç§Ÿè»Šå…¬å¸</label>
                            <input className="input-journal" value={formData.company || ''} onChange={e => setFormData({...formData, company: e.target.value})} />
                        </div>
                    )}

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åƒ¹æ ¼</label>
                        <input className="input-journal" value={formData.price || ''} onChange={e => setFormData({...formData, price: e.target.value})} />
                    </div>
                </div>

                <div className="p-4 border-t border-[#E0E5D5] flex gap-3 bg-[#F7F4EB] rounded-b-[20px]">
                    {initialData && (
                        <Button 
                            variant={isDeleting ? "danger" : "outline"} 
                            className={cn("flex-1 transition-all", isDeleting && "bg-red-500 text-white border-red-500")}
                            onClick={handleDelete}
                        >
                            {isDeleting ? "ç¢ºå®šåˆªé™¤?" : <><Trash2 size={16} /> åˆªé™¤</>}
                        </Button>
                    )}
                    <Button className="flex-[2]" onClick={() => onSave(formData)}>
                        å„²å­˜
                    </Button>
                </div>
            </Card>
        </div>
    );
}

const ExpenseModal = ({ 
    isOpen, 
    onClose, 
    onSave, 
    onDelete,
    initialData 
}: { 
    isOpen: boolean; 
    onClose: () => void; 
    onSave: (data: Partial<ExpenseItem>) => void;
    onDelete?: () => void;
    initialData?: ExpenseItem; 
}) => {
    if (!isOpen) return null;

    const [formData, setFormData] = useState<Partial<ExpenseItem>>({
        date: '2026-01-14',
        currency: 'JPY',
        category: 'food',
        paymentMethod: 'cash'
    });
    const [isDeleting, setIsDeleting] = useState(false);

    useEffect(() => {
        setFormData({ 
            date: '2026-01-14',
            currency: 'JPY',
            category: 'food',
            paymentMethod: 'cash',
            ...initialData 
        });
        setIsDeleting(false);
    }, [initialData, isOpen]);

    const handleDelete = () => {
        if (isDeleting) {
            if (onDelete) onDelete();
        } else {
            setIsDeleting(true);
            setTimeout(() => setIsDeleting(false), 3000);
        }
    };

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose} />
            <Card className="w-full max-w-sm relative z-10 animate-bounce-slight" noPadding>
                <div className="p-4 border-b border-[#E0E5D5] flex justify-between items-center bg-[#F7F4EB] rounded-t-[20px]">
                    <h3 className="font-bold text-lg text-[#4A4A4A]">
                        {initialData ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º'}
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-[#E0E5D5] rounded-full">
                        <X size={20} />
                    </button>
                </div>
                
                <div className="p-5 space-y-4">
                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label>
                        <input 
                            type="date"
                            className="input-journal"
                            value={formData.date || ''}
                            onChange={e => setFormData({...formData, date: e.target.value})}
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">é …ç›®åç¨±</label>
                        <input 
                            className="input-journal"
                            value={formData.title || ''}
                            onChange={e => setFormData({...formData, title: e.target.value})}
                            placeholder="ä¾‹å¦‚ï¼šåˆé¤"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                         <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">é‡‘é¡</label>
                            <input 
                                type="number"
                                className="input-journal"
                                value={formData.amount || 0}
                                onChange={e => setFormData({...formData, amount: parseFloat(e.target.value)})}
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">å¹£åˆ¥</label>
                            <div className="flex bg-white rounded-xl border-2 border-[#E0E5D5] overflow-hidden">
                                <button 
                                    onClick={() => setFormData({...formData, currency: 'JPY'})}
                                    className={cn("flex-1 py-2 text-xs font-bold", formData.currency === 'JPY' ? 'bg-[#88B04B] text-white' : 'text-gray-400')}
                                >
                                    JPY
                                </button>
                                <button 
                                    onClick={() => setFormData({...formData, currency: 'TWD'})}
                                    className={cn("flex-1 py-2 text-xs font-bold", formData.currency === 'TWD' ? 'bg-[#FF8C42] text-white' : 'text-gray-400')}
                                >
                                    TWD
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label>
                        <select 
                            className="input-journal bg-white"
                            value={formData.category || 'food'}
                            onChange={e => setFormData({...formData, category: e.target.value as EventType})}
                        >
                            {EVENT_TYPES.map(t => (
                                <option key={t.value} value={t.value}>{t.label}</option>
                            ))}
                        </select>
                    </div>

                     <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾æ–¹å¼</label>
                        <div className="grid grid-cols-3 gap-2">
                             {PAYMENT_METHODS.map(m => (
                                <button 
                                    key={m.value}
                                    onClick={() => setFormData({...formData, paymentMethod: m.value})}
                                    className={cn(
                                        "py-2 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-1 border-2 transition-all", 
                                        formData.paymentMethod === m.value 
                                            ? "border-[#88B04B] bg-[#88B04B]/10 text-[#88B04B]" 
                                            : "border-[#E0E5D5] bg-white text-gray-400"
                                    )}
                                >
                                    <m.icon size={16} />
                                    {m.label}
                                </button>
                             ))}
                        </div>
                    </div>
                </div>

                <div className="p-4 border-t border-[#E0E5D5] flex gap-3 bg-[#F7F4EB] rounded-b-[20px]">
                    {initialData && (
                        <Button 
                            variant={isDeleting ? "danger" : "outline"} 
                            className={cn("flex-1 transition-all", isDeleting && "bg-red-500 text-white border-red-500")}
                            onClick={handleDelete}
                        >
                            {isDeleting ? "ç¢ºå®šåˆªé™¤?" : <><Trash2 size={16} /> åˆªé™¤</>}
                        </Button>
                    )}
                    <Button className="flex-[2]" onClick={() => onSave(formData)}>
                        å„²å­˜
                    </Button>
                </div>
            </Card>
        </div>
    );
};

const MustModal = ({ 
    isOpen, 
    onClose, 
    onSave, 
    onDelete,
    initialData 
}: { 
    isOpen: boolean; 
    onClose: () => void; 
    onSave: (data: Partial<MustItem>) => void;
    onDelete?: () => void;
    initialData?: MustItem; 
}) => {
    if (!isOpen) return null;

    const [formData, setFormData] = useState<Partial<MustItem>>({
        type: 'eat',
        area: 'åå¤å±‹',
        isCompleted: false
    });
    const [isDeleting, setIsDeleting] = useState(false);

    useEffect(() => {
        setFormData({
            type: 'eat',
            area: 'åå¤å±‹',
            isCompleted: false,
            ...initialData
        });
        setIsDeleting(false);
    }, [initialData, isOpen]);

    const handleDelete = () => {
        if (isDeleting) {
            if (onDelete) onDelete();
        } else {
            setIsDeleting(true);
            setTimeout(() => setIsDeleting(false), 3000);
        }
    };

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose} />
            <Card className="w-full max-w-sm relative z-10 animate-bounce-slight" noPadding>
                <div className="p-4 border-b border-[#E0E5D5] flex justify-between items-center bg-[#F7F4EB] rounded-t-[20px]">
                    <h3 className="font-bold text-lg text-[#4A4A4A]">
                        {initialData ? 'ç·¨è¼¯é …ç›®' : 'æ–°å¢å¿…åƒ/å¿…è²·'}
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-[#E0E5D5] rounded-full">
                        <X size={20} />
                    </button>
                </div>
                
                <div className="p-5 space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label>
                            <div className="flex bg-white rounded-xl border-2 border-[#E0E5D5] overflow-hidden">
                                <button 
                                    onClick={() => setFormData({...formData, type: 'eat'})}
                                    className={cn("flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1", formData.type === 'eat' ? 'bg-[#FF8C42] text-white' : 'text-gray-400')}
                                >
                                    <Utensils size={12} /> ç¾é£Ÿ
                                </button>
                                <button 
                                    onClick={() => setFormData({...formData, type: 'buy'})}
                                    className={cn("flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1", formData.type === 'buy' ? 'bg-[#88B04B] text-white' : 'text-gray-400')}
                                >
                                    <Gift size={12} /> è³¼ç‰©
                                </button>
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">åœ°å€</label>
                            <select 
                                className="input-journal bg-white"
                                value={formData.area || 'åå¤å±‹'}
                                onChange={e => setFormData({...formData, area: e.target.value})}
                            >
                                {MUST_AREAS.map(area => (
                                    <option key={area} value={area}>{area}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åç¨±</label>
                        <input 
                            className="input-journal"
                            value={formData.name || ''}
                            onChange={e => setFormData({...formData, name: e.target.value})}
                            placeholder="ä¾‹å¦‚ï¼šèµ¤ç¦"
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">åœ°å€ (å°èˆªç”¨)</label>
                        <input 
                            className="input-journal"
                            value={formData.location || ''}
                            onChange={e => setFormData({...formData, location: e.target.value})}
                            placeholder="è¼¸å…¥åœ°å€æˆ–é—œéµå­—"
                        />
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 mb-1">å‚™è¨»</label>
                        <textarea 
                            className="input-journal h-20"
                            value={formData.note || ''}
                            onChange={e => setFormData({...formData, note: e.target.value})}
                            placeholder="å¿…é»å“é …ã€ä½ç½®..."
                        />
                    </div>
                </div>

                <div className="p-4 border-t border-[#E0E5D5] flex gap-3 bg-[#F7F4EB] rounded-b-[20px]">
                    {initialData && (
                        <Button 
                            variant={isDeleting ? "danger" : "outline"} 
                            className={cn("flex-1 transition-all", isDeleting && "bg-red-500 text-white border-red-500")}
                            onClick={handleDelete}
                        >
                            {isDeleting ? "ç¢ºå®šåˆªé™¤?" : <><Trash2 size={16} /> åˆªé™¤</>}
                        </Button>
                    )}
                    <Button className="flex-[2]" onClick={() => onSave(formData)}>
                        å„²å­˜
                    </Button>
                </div>
            </Card>
        </div>
    );
};

// --- 8. Feature Components ---

const FlightCard = ({ item, onClick }: { item: BookingItem, onClick: () => void }) => (
    <Card className="mb-4 relative overflow-hidden cursor-pointer hover:scale-[1.01] transition-transform" noPadding onClick={onClick}>
        <div className="bg-[#0EA5E9] p-3 flex justify-between items-center text-white">
            <div className="flex items-center gap-2">
                <Plane size={18} className="rotate-45" />
                <span className="font-bold text-sm tracking-widest">{item.airline || 'AIRLINE'}</span>
            </div>
            <span className="font-mono font-bold">{item.dateRange}</span>
        </div>
        <div className="p-5 flex justify-between items-center relative">
             <div className="flex flex-col items-start">
                 <span className="text-3xl font-black text-[#4A4A4A]">{item.deptCode}</span>
                 <span className="text-lg font-bold text-[#0EA5E9]">{item.deptTime}</span>
             </div>
             <div className="flex flex-col items-center justify-center gap-1 w-1/3">
                 <span className="text-xs font-bold text-gray-300 tracking-wider">{item.flightNumber}</span>
                 <div className="w-full h-[2px] bg-gray-200 relative">
                     <div className="absolute right-0 top-1/2 -translate-y-1/2 w-2 h-2 bg-gray-300 rounded-full" />
                     <Plane size={14} className="text-[#0EA5E9] absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rotate-90 bg-white" />
                 </div>
                 <span className="text-[10px] text-gray-400">Direct</span>
             </div>
             <div className="flex flex-col items-end">
                 <span className="text-3xl font-black text-[#4A4A4A]">{item.arrCode}</span>
                 <span className="text-lg font-bold text-[#0EA5E9]">{item.arrTime}</span>
             </div>
             <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <Edit3 size={16} className="text-gray-400" />
             </div>
        </div>
    </Card>
);

const HotelCard = ({ item, onClick }: { item: BookingItem, onClick: () => void }) => (
    <Card className="mb-4 flex flex-col gap-3 group cursor-pointer hover:scale-[1.01] transition-transform" onClick={onClick}>
        <div className="flex justify-between items-start">
            <div className="flex gap-3">
                <div className="w-10 h-10 rounded-xl bg-[#8B5CF6]/10 flex items-center justify-center text-[#8B5CF6]">
                    <BedDouble size={20} />
                </div>
                <div>
                    <div className="flex items-center gap-2 text-xs font-bold text-gray-400 mb-0.5">
                        <CalendarDays size={12} /> {item.dateRange}
                    </div>
                    <h4 className="font-bold text-[#4A4A4A] leading-tight">{item.hotelName}</h4>
                </div>
            </div>
        </div>
        <div className="pl-[52px] space-y-2">
            <div className="text-xs text-gray-500 bg-[#F7F4EB] p-2 rounded-lg border border-[#E0E5D5]/50 flex items-center gap-2">
                <Info size={12} className="text-[#8B5CF6]" /> {item.roomDetail}
            </div>
            <div className="flex justify-end items-center gap-1">
                <span className="text-xs font-bold text-gray-300">Total</span>
                <span className="text-lg font-black text-[#4A4A4A]">{item.price}</span>
            </div>
        </div>
    </Card>
);

const RentalCard = ({ item, onClick }: { item: BookingItem, onClick: () => void }) => (
    <Card className="mb-4 bg-gradient-to-r from-orange-50 to-white border-orange-100 cursor-pointer hover:scale-[1.01] transition-transform" onClick={onClick}>
        <div className="flex justify-between items-start mb-3">
            <div className="flex gap-3">
                <div className="w-10 h-10 rounded-xl bg-[#FF8C42]/10 flex items-center justify-center text-[#FF8C42]">
                    <Car size={20} />
                </div>
                <div>
                    <h4 className="font-bold text-[#4A4A4A]">{item.company}</h4>
                    <span className="text-xs text-gray-400 font-bold">{item.pickUpLoc}</span>
                </div>
            </div>
        </div>
        <div className="flex items-center gap-4 text-xs font-bold text-gray-500 mb-3 bg-white/60 p-2 rounded-lg">
            <div className="flex flex-col">
                <span className="text-[10px] text-gray-300">PICK-UP</span>
                <span>{item.pickUpTime}</span>
            </div>
            <ArrowRight size={14} className="text-gray-300" />
             <div className="flex flex-col">
                <span className="text-[10px] text-gray-300">DROP-OFF</span>
                <span>{item.dropOffTime}</span>
            </div>
        </div>
        <div className="flex justify-between items-center border-t border-orange-100 pt-2">
            <span className="text-xs text-gray-400 font-bold">{item.carModel}</span>
            <span className="text-lg font-black text-[#FF8C42]">{item.price}</span>
        </div>
    </Card>
);

// --- 9. Page Components ---

const BookingsPage = ({ 
    bookings, 
    onEdit 
}: { 
    bookings: BookingItem[], 
    onEdit: (item: BookingItem) => void 
}) => {
    const flights = bookings.filter(b => b.type === 'flight');
    const hotels = bookings.filter(b => b.type === 'hotel');
    const rentals = bookings.filter(b => b.type === 'rental');

    return (
        <div className="pb-24 space-y-6">
            {flights.length > 0 && (
                <section>
                    <h3 className="text-sm font-bold text-[#8D6E63] mb-3 ml-1 flex items-center gap-2">
                        <Plane size={14} /> FLIGHTS
                    </h3>
                    {flights.map(item => <FlightCard key={item.id} item={item} onClick={() => onEdit(item)} />)}
                </section>
            )}
            {hotels.length > 0 && (
                <section>
                    <h3 className="text-sm font-bold text-[#8D6E63] mb-3 ml-1 flex items-center gap-2">
                        <BedDouble size={14} /> HOTELS
                    </h3>
                    {hotels.map(item => <HotelCard key={item.id} item={item} onClick={() => onEdit(item)} />)}
                </section>
            )}
            {rentals.length > 0 && (
                <section>
                    <h3 className="text-sm font-bold text-[#8D6E63] mb-3 ml-1 flex items-center gap-2">
                        <Car size={14} /> RENTAL CAR
                    </h3>
                    {rentals.map(item => <RentalCard key={item.id} item={item} onClick={() => onEdit(item)} />)}
                </section>
            )}
        </div>
    );
};

const ExpensePage = ({ 
    expenses, 
    onEdit,
    exchangeRate,
    setExchangeRate
}: { 
    expenses: ExpenseItem[], 
    onEdit: (item: ExpenseItem) => void,
    exchangeRate: number,
    setExchangeRate: (rate: number) => void
}) => {
    
    // Calculate Totals
    const totalJPY = expenses.filter(e => e.currency === 'JPY').reduce((acc, curr) => acc + curr.amount, 0);
    const totalTWD = expenses.filter(e => e.currency === 'TWD').reduce((acc, curr) => acc + curr.amount, 0);
    
    // Group by Date
    const groupedExpenses = useMemo(() => {
        const groups: Record<string, ExpenseItem[]> = {};
        expenses.forEach(item => {
            if (!groups[item.date]) groups[item.date] = [];
            groups[item.date].push(item);
        });
        return groups;
    }, [expenses]);
    
    const sortedDates = Object.keys(groupedExpenses).sort();

    return (
        <div className="pb-24 space-y-6">
            {/* Dashboard */}
            <section className="grid grid-cols-2 gap-3">
                <Card className="flex flex-col items-center justify-center gap-1 py-4 bg-white border-[#E0E5D5]">
                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                        <JapaneseYen size={12}/> æ—¥å¹£ç¸½æ”¯
                    </div>
                    <div className="font-extrabold text-xl text-[#4A4A4A]">Â¥{totalJPY.toLocaleString()}</div>
                </Card>
                <Card className="flex flex-col items-center justify-center gap-1 py-4 bg-white border-[#E0E5D5]">
                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                        <DollarSign size={12}/> å°å¹£ç¸½æ”¯
                    </div>
                    <div className="font-extrabold text-xl text-[#4A4A4A]">${totalTWD.toLocaleString()}</div>
                </Card>
                
                {/* Rate Setting */}
                <Card className="col-span-2 flex items-center justify-between py-2 px-4 bg-[#F7F4EB] border border-[#E0E5D5]/50">
                    <div className="flex items-center gap-2 text-xs font-bold text-gray-400">
                        <Settings size={12} /> åŒ¯ç‡è¨­å®š (JPY â†’ TWD)
                    </div>
                    <div className="flex items-center gap-2">
                        <input 
                            type="number" 
                            step="0.001"
                            value={exchangeRate}
                            onChange={(e) => setExchangeRate(parseFloat(e.target.value))}
                            className="w-16 text-right font-bold text-[#4A4A4A] bg-white border border-[#E0E5D5] rounded-md px-1 py-0.5 text-sm outline-none focus:border-[#88B04B]"
                        />
                    </div>
                </Card>

                <div className="col-span-2 text-center text-[10px] text-gray-400 font-bold">
                    ç´„åˆå°å¹£ç¸½è¨ˆ: <span className="text-[#88B04B]">${(totalTWD + totalJPY * exchangeRate).toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                </div>
            </section>

            {/* Expense List */}
            <div className="space-y-6">
                {sortedDates.map(date => (
                    <div key={date}>
                        <h3 className="text-sm font-bold text-[#8D6E63] mb-3 ml-1 bg-[#E0E5D5]/30 inline-block px-2 py-1 rounded-md">
                            {date}
                        </h3>
                        <div className="space-y-3">
                            {groupedExpenses[date].map(item => {
                                const style = TYPE_STYLES[item.category] || TYPE_STYLES.other;
                                const Icon = style.icon;
                                const payment = PAYMENT_METHODS.find(m => m.value === item.paymentMethod) || PAYMENT_METHODS[0];
                                const PaymentIcon = payment.icon;

                                return (
                                    <Card key={item.id} className="flex justify-between items-center p-3 cursor-pointer hover:border-[#88B04B]" noPadding onClick={() => onEdit(item)}>
                                        <div className="flex items-center gap-3 pl-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center`} style={{ backgroundColor: style.bg, color: style.color }}>
                                                <Icon size={16} />
                                            </div>
                                            <div>
                                                <div className="font-bold text-sm text-[#4A4A4A]">{item.title}</div>
                                                <div className="flex items-center gap-2 mt-0.5">
                                                     <div className="text-[10px] font-bold px-1.5 py-0.5 rounded-md bg-gray-100 text-gray-500 flex items-center gap-1">
                                                         <PaymentIcon size={10} /> {payment.label}
                                                     </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="pr-4 text-right">
                                            <div className={cn("font-extrabold text-sm", item.currency === 'JPY' ? "text-[#4A4A4A]" : "text-[#FF8C42]")}>
                                                {item.currency === 'JPY' ? 'Â¥' : '$'}{item.amount.toLocaleString()}
                                            </div>
                                            <div className="text-[10px] text-gray-300 font-bold">{item.currency}</div>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const MustListPage = ({
    items,
    onToggle,
    onEdit
}: {
    items: MustItem[],
    onToggle: (id: string) => void,
    onEdit: (item: MustItem) => void
}) => {
    const [activeTab, setActiveTab] = useState<MustType>('eat');

    const filteredItems = items.filter(item => item.type === activeTab);
    
    // Group by Area
    const groupedItems = useMemo(() => {
        const groups: Record<string, MustItem[]> = {};
        MUST_AREAS.forEach(area => groups[area] = []);
        filteredItems.forEach(item => {
            const area = item.area || 'å…¶ä»–';
            if (!groups[area]) groups[area] = [];
            groups[area].push(item);
        });
        return groups;
    }, [filteredItems]);

    const openGoogleMap = (name: string, area: string, location?: string) => {
        const query = encodeURIComponent(location || `${area} ${name}`);
        window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
    };

    return (
        <div className="pb-24 space-y-6">
            {/* Tabs */}
            <div className="flex gap-2 bg-white p-1 rounded-xl shadow-sm border border-[#E0E5D5]">
                <button
                    onClick={() => setActiveTab('eat')}
                    className={cn(
                        "flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all",
                        activeTab === 'eat' ? "bg-[#FF8C42] text-white shadow-soft" : "text-gray-400 hover:bg-gray-50"
                    )}
                >
                    <Utensils size={16} /> ç¾é£Ÿ (EAT)
                </button>
                <button
                    onClick={() => setActiveTab('buy')}
                    className={cn(
                        "flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all",
                        activeTab === 'buy' ? "bg-[#88B04B] text-white shadow-soft" : "text-gray-400 hover:bg-gray-50"
                    )}
                >
                    <Gift size={16} /> è³¼ç‰© (BUY)
                </button>
            </div>

            {/* List */}
            <div className="space-y-6">
                {MUST_AREAS.map(area => {
                    const areaItems = groupedItems[area];
                    if (!areaItems || areaItems.length === 0) return null;

                    return (
                        <div key={area}>
                            <h3 className="text-sm font-bold text-[#8D6E63] mb-3 ml-1 flex items-center gap-2">
                                <MapPin size={14} /> {area}
                            </h3>
                            <div className="space-y-3">
                                {areaItems.map(item => (
                                    <Card 
                                        key={item.id} 
                                        className={cn(
                                            "flex items-center gap-3 p-3 cursor-pointer hover:border-[#88B04B] transition-all relative overflow-hidden",
                                            item.isCompleted && "bg-gray-50"
                                        )}
                                        noPadding
                                        onClick={() => onEdit(item)}
                                    >
                                        {/* Left Status Bar */}
                                        <div className={cn("w-1.5 self-stretch mr-2", activeTab === 'eat' ? "bg-[#FF8C42]" : "bg-[#88B04B]")} />

                                        {/* Content */}
                                        <div className={cn("flex-1 py-2", item.isCompleted && "opacity-50 grayscale")}>
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-[10px] font-bold px-1.5 py-0.5 rounded bg-gray-100 text-gray-500">
                                                    {item.area}
                                                </span>
                                                <h4 className={cn("font-bold text-[#4A4A4A] leading-tight", item.isCompleted && "line-through")}>
                                                    {item.name}
                                                </h4>
                                            </div>
                                            {item.note && (
                                                <p className="text-xs text-gray-400 line-clamp-1">{item.note}</p>
                                            )}
                                        </div>

                                        {/* Actions */}
                                        <div className="flex items-center gap-1 pr-3">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); openGoogleMap(item.name, item.area, item.location); }}
                                                className="w-9 h-9 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center hover:bg-blue-100 transition-colors"
                                            >
                                                <MapPin size={16} />
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onToggle(item.id); }}
                                                className={cn(
                                                    "w-9 h-9 rounded-full border-2 flex items-center justify-center transition-colors",
                                                    item.isCompleted 
                                                        ? "bg-[#88B04B] border-[#88B04B] text-white" 
                                                        : "border-[#E0E5D5] text-transparent hover:border-[#88B04B]"
                                                )}
                                            >
                                                <Check size={16} strokeWidth={3} />
                                            </button>
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

const SchedulePage = ({ 
    tripData, 
    selectedDate, 
    setSelectedDate, 
    updateEventsForDay, 
    openModal, 
    setEditingEvent 
}: any) => {
  
  // Drag and Drop state
  const [draggedEventId, setDraggedEventId] = useState<string | null>(null);
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const [dailyWeather, setDailyWeather] = useState<HourlyWeather[]>([]);
  const [isLoadingWeather, setIsLoadingWeather] = useState(false);
  
  const currentDayIndex = tripData.findIndex((d: TripDay) => d.date === selectedDate);
  const currentDay = tripData[currentDayIndex] || tripData[0];

  // Dynamic Weather Title using mainLocation
  const weatherLocation = currentDay.mainLocation;

  // Fetch Weather when location changes
  useEffect(() => {
      setIsLoadingWeather(true);
      fetchWeatherForLocation(weatherLocation).then(data => {
          setDailyWeather(data);
          setIsLoadingWeather(false);
      });
  }, [weatherLocation]);

  // --- Handlers ---
  const openGoogleMaps = (location: string) => {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
      window.open(url, '_blank');
  };

  // Note: handleNoteChange removed as direct editing is removed
  // If we need to update note via modal, it's done via handleSaveTripEvent in App

  // --- Drag and Drop Handlers ---
  const handleDragStart = (e: React.DragEvent, id: string) => {
    setDraggedEventId(id);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e: React.DragEvent, targetId: string) => {
      e.preventDefault();
      if (!draggedEventId || draggedEventId === targetId) return;

      const fromIndex = currentDay.events.findIndex((e: TripEvent) => e.id === draggedEventId);
      const toIndex = currentDay.events.findIndex((e: TripEvent) => e.id === targetId);

      if (fromIndex < 0 || toIndex < 0) return;

      const newEvents = [...currentDay.events];
      const [movedItem] = newEvents.splice(fromIndex, 1);
      newEvents.splice(toIndex, 0, movedItem);

      updateEventsForDay(newEvents);
  };

  const handleDragEnd = () => {
      setDraggedEventId(null);
  };

  // --- Renderers ---
  const renderEventCard = (event: TripEvent) => {
      const style = TYPE_STYLES[event.type] || TYPE_STYLES.other;
      const Icon = style.icon;
      const isFlight = event.type === 'flight';

      if (isFlight) {
        return (
            <div key={event.id} className="relative group">
               <div 
                 className="absolute -left-3 top-1/2 -translate-y-1/2 p-2 cursor-grab text-gray-300 hover:text-[#88B04B]"
                 draggable
                 onDragStart={(e) => handleDragStart(e, event.id)}
                 onDragEnd={handleDragEnd}
               >
                   <GripVertical size={16} />
               </div>
               
               <Card 
                  className="bg-white ml-4 relative overflow-hidden border-none shadow-ticket"
                  noPadding
                  draggable
                  onDragOver={(e) => handleDragOver(e, event.id)}
                  // Removing onClick to prevent modal open, now specific buttons do actions
               >
                    <div className="h-2 bg-[#0EA5E9]" />
                    <div className="p-4 flex gap-4">
                        <div className="flex flex-col items-center justify-center border-r-2 border-dashed border-gray-200 pr-4">
                             <Plane size={24} className="text-[#0EA5E9] mb-1" />
                             <span className="text-xs font-bold text-gray-400">FLIGHT</span>
                        </div>
                        <div className="flex-1">
                             <div className="flex justify-between items-start">
                                 <h4 className="font-extrabold text-lg text-[#4A4A4A]">{event.title}</h4>
                                 
                                 {/* Action Buttons */}
                                 <div className="flex gap-2">
                                     <button 
                                        onClick={(e) => { e.stopPropagation(); setEditingEvent(event); openModal(); }}
                                        className="p-1.5 rounded-full hover:bg-gray-100 text-gray-400"
                                     >
                                         <Edit3 size={16} />
                                     </button>
                                 </div>
                             </div>
                             <div className="flex items-center gap-2 text-sm text-gray-500 mt-1">
                                 <Clock size={14} /> 
                                 <span className="font-mono font-bold">{event.time}</span>
                                 <span className="text-gray-300">|</span>
                                 <span>{event.location}</span>
                             </div>
                             
                             {/* Description Area (Read Only) */}
                             {event.description && (
                                <div className="mt-2 text-xs bg-[#E0F2FE] text-[#0369A1] px-2 py-1 rounded inline-block font-bold">
                                     {event.description}
                                </div>
                             )}
                             
                             {/* Navigation Button */}
                             <div className="mt-3">
                                <button 
                                    onClick={(e) => { e.stopPropagation(); openGoogleMaps(event.location || event.title); }}
                                    className="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 transition-colors shadow-sm"
                                >
                                    <MapPin size={16} /> å°èˆªè‡³ {event.location || 'ç›®çš„åœ°'}
                                </button>
                             </div>
                        </div>
                    </div>
                    <div className="absolute -left-2 top-1/2 w-4 h-4 bg-[#F7F4EB] rounded-full" />
                    <div className="absolute -right-2 top-1/2 w-4 h-4 bg-[#F7F4EB] rounded-full" />
               </Card>
            </div>
        );
      }

      return (
        <div key={event.id} className="flex gap-4 group relative items-start" 
             onDragOver={(e) => handleDragOver(e, event.id)}>
          
          <div className="w-12 flex flex-col items-center pt-1 gap-1 flex-shrink-0 z-10 bg-[#F7F4EB]">
            <span className="text-sm font-bold text-gray-500 font-mono tracking-tight">{event.time}</span>
            <div 
              className="w-3 h-3 rounded-full ring-4 ring-[#F7F4EB] transition-colors" 
              style={{ backgroundColor: style.color }}
            />
          </div>

          <div 
            className="absolute left-10 top-8 text-gray-300 hover:text-[#88B04B] cursor-grab z-20 opacity-0 group-hover:opacity-100 transition-opacity"
            draggable
            onDragStart={(e) => handleDragStart(e, event.id)}
            onDragEnd={handleDragEnd}
          >
              <GripVertical size={16} />
          </div>

          <Card 
            className={cn(
                "flex-1 transition-all relative overflow-hidden group-hover:shadow-soft-hover select-none",
                draggedEventId === event.id ? "dragging" : ""
            )}
          >
             <div className="absolute top-0 left-0 right-0 h-1 opacity-60" style={{ backgroundColor: style.color }} />
             
            <div className="flex justify-between items-start mb-2 mt-1">
              <span 
                className="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold"
                style={{ backgroundColor: style.bg, color: style.color }}
              >
                <Icon size={12} strokeWidth={2.5} /> {style.label}
              </span>
              
              {/* Edit Button */}
              <button 
                className="p-2 rounded-full text-gray-300 hover:text-gray-500 hover:bg-gray-100 -mr-2 -mt-2"
                title="ç·¨è¼¯"
                onClick={(e) => {
                    e.stopPropagation();
                    setEditingEvent(event);
                    openModal();
                }}
              >
                  <Edit3 size={18} />
              </button>
            </div>
            
            <h4 className="font-bold text-lg text-[#4A4A4A] leading-tight mb-1 pr-8">{event.title}</h4>
            
            <div className="space-y-1 mb-3">
                {event.location && (
                    <div className="flex items-center gap-1 text-xs text-gray-400 font-medium">
                        <Navigation size={10} /> 
                        <span>{event.location}</span>
                    </div>
                )}
                
                {(event.businessHours || event.ticketPrice) && (
                    <div className="flex gap-3 text-[10px] text-gray-500 font-bold mt-1">
                        {event.businessHours && (
                            <span className="flex items-center gap-1"><Clock size={10}/> {event.businessHours}</span>
                        )}
                        {event.ticketPrice && (
                            <span className="flex items-center gap-1 bg-yellow-100 text-yellow-700 px-1.5 rounded"><Ticket size={10}/> {event.ticketPrice}</span>
                        )}
                    </div>
                )}
            </div>
            
            {/* Description Area (Read Only) */}
            {event.description && (
                <div className="text-xs text-[#8D6E63]/90 bg-[#F7F4EB] p-2 rounded-lg border border-[#E0E5D5]/50 leading-relaxed mb-3">
                    {event.description}
                    {event.notes && <p className="mt-1 text-[10px] text-gray-400 border-t border-[#E0E5D5] pt-1">ğŸ’¡ {event.notes}</p>}
                </div>
            )}
            
            {/* Navigation Button (Full width at bottom) */}
            <div className="mt-2">
                <button 
                    onClick={(e) => {
                        e.stopPropagation();
                        openGoogleMaps(event.location || event.title);
                    }}
                    className="w-full flex items-center justify-center gap-2 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 transition-colors shadow-sm"
                >
                    <MapPin size={16} /> å°èˆªè‡³ {event.location || 'ç›®çš„åœ°'}
                </button>
            </div>
          </Card>
        </div>
      );
  };

  return (
    <>
      {/* 1. Date Selector */}
      <section className="mb-4 sticky top-0 bg-[#F7F4EB] z-30 py-2 -mx-5 px-5 shadow-sm">
        <div 
          ref={scrollContainerRef}
          className="flex overflow-x-auto gap-3 pb-1 scrollbar-hide snap-x"
        >
          {tripData.map((day: TripDay) => {
            const isSelected = selectedDate === day.date;
            return (
              <button
                key={day.date}
                onClick={() => setSelectedDate(day.date)}
                className={cn(
                  "flex-shrink-0 flex flex-col items-center justify-center w-[60px] h-[80px] rounded-2xl border-2 transition-all duration-300 snap-center",
                  isSelected 
                    ? "bg-[#88B04B] border-[#88B04B] text-white shadow-soft translate-y-1" 
                    : "bg-white border-[#E0E5D5] text-[#8D6E63] hover:border-[#88B04B]/50"
                )}
              >
                <span className={cn("text-2xl font-black leading-none", isSelected ? "text-white" : "text-[#88B04B]")}>
                  {day.weekday}
                </span>
                <span className={cn("text-sm font-bold opacity-80 mt-1")}>
                  {day.date.split('-')[2]}
                </span>
              </button>
            );
          })}
        </div>
      </section>

      {/* 2. Hourly Weather Forecast */}
      <section className="mb-6 animate-fade-in">
        <Card className="px-5 py-4 bg-gradient-to-br from-blue-50 to-white border-blue-100 relative overflow-hidden min-h-[140px]">
             <div className="flex items-center gap-2 mb-3 text-blue-800 font-bold text-sm">
                 <CloudSun size={18} />
                 ğŸ“ {weatherLocation} çš„å¤©æ°£
             </div>
             
             {isLoadingWeather ? (
                 <div className="flex items-center justify-center h-20 text-blue-300">
                     <Loader2 className="animate-spin" size={24} />
                 </div>
             ) : (
                 <div className="flex overflow-x-auto gap-4 pb-2 scrollbar-hide">
                    {dailyWeather.map((hour: HourlyWeather, idx: number) => (
                        <div key={idx} className="flex flex-col items-center gap-1 flex-shrink-0 w-12 animate-fade-in" style={{ animationDelay: `${idx * 50}ms` }}>
                            <span className="text-xs text-gray-400 font-bold">{hour.time}</span>
                            <hour.icon size={24} className="text-[#0EA5E9] my-1" />
                            <span className="text-sm font-extrabold text-[#4A4A4A]">{hour.temp}</span>
                        </div>
                    ))}
                 </div>
             )}
        </Card>
      </section>

      {/* 3. Timeline & Events */}
      <section className="relative pb-24">
        <div className="absolute left-[23px] top-2 bottom-6 w-0.5 bg-[#E0E5D5] -z-10 border-l-2 border-dotted border-[#E0E5D5]" />
        
        <div className="space-y-6">
            {currentDay.events.map((event: TripEvent) => renderEventCard(event))}
          
          <div className="flex gap-4 opacity-50">
             <div className="w-12 flex flex-col items-center">
                 <div className="w-2 h-2 rounded-full bg-[#E0E5D5]" />
             </div>
             <div className="flex-1 text-xs text-center text-gray-400 font-bold border-t-2 border-[#E0E5D5] border-dashed pt-2">
                End of Day {currentDay.dayNum}
             </div>
          </div>
        </div>
      </section>
    </>
  );
};

// --- 10. App Entry ---
export default function App() {
  const [activeTab, setActiveTab] = useState('schedule');
  const [exchangeRate, setExchangeRate] = useState(0.22);
  
  // Trip State
  const [tripData, setTripData] = useState<TripDay[]>(INITIAL_TRIP_DATA);
  const [selectedDate, setSelectedDate] = useState('2026-01-14');
  const [isTripModalOpen, setIsTripModalOpen] = useState(false);
  const [editingTripEvent, setEditingTripEvent] = useState<TripEvent | undefined>(undefined);

  // Booking State
  const [bookings, setBookings] = useState<BookingItem[]>(INITIAL_BOOKINGS);
  const [isBookingModalOpen, setIsBookingModalOpen] = useState(false);
  const [editingBooking, setEditingBooking] = useState<BookingItem | undefined>(undefined);

  // Expense State
  const [expenses, setExpenses] = useState<ExpenseItem[]>(generateInitialExpenses());
  const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
  const [editingExpense, setEditingExpense] = useState<ExpenseItem | undefined>(undefined);

  // Must List State
  const [mustList, setMustList] = useState<MustItem[]>(INITIAL_MUST_LIST);
  const [isMustModalOpen, setIsMustModalOpen] = useState(false);
  const [editingMust, setEditingMust] = useState<MustItem | undefined>(undefined);

  // --- Trip Handlers ---
  const updateEventsForDay = (newEvents: TripEvent[]) => {
      const currentDayIndex = tripData.findIndex(d => d.date === selectedDate);
      if (currentDayIndex === -1) return;
      const newData = [...tripData];
      newData[currentDayIndex] = { ...newData[currentDayIndex], events: newEvents };
      setTripData(newData);
  };

  const handleSaveTripEvent = (data: Partial<TripEvent>) => {
      const currentDayIndex = tripData.findIndex(d => d.date === selectedDate);
      if (currentDayIndex === -1) return;
      
      const currentEvents = tripData[currentDayIndex].events;
      let newEvents;

      if (editingTripEvent) {
          newEvents = currentEvents.map(e => e.id === editingTripEvent.id ? { ...e, ...data } as TripEvent : e);
      } else {
          const newEvent: TripEvent = {
              id: Date.now().toString(),
              time: data.time || '10:00',
              title: data.title || 'æ–°è¡Œç¨‹',
              type: data.type || 'sightseeing',
              ...data
          } as TripEvent;
          newEvents = [...currentEvents, newEvent];
      }
      
      newEvents.sort((a, b) => a.time.localeCompare(b.time));
      
      const newData = [...tripData];
      newData[currentDayIndex] = { ...newData[currentDayIndex], events: newEvents };
      setTripData(newData);
      
      setIsTripModalOpen(false);
      setEditingTripEvent(undefined);
  };

  const handleDeleteTripEvent = () => {
      if (!editingTripEvent) return;
      const currentDayIndex = tripData.findIndex(d => d.date === selectedDate);
      if (currentDayIndex === -1) return;

      const currentEvents = tripData[currentDayIndex].events.filter(e => e.id !== editingTripEvent.id);
      
      const newData = [...tripData];
      newData[currentDayIndex] = { ...newData[currentDayIndex], events: currentEvents };
      setTripData(newData);
      
      setIsTripModalOpen(false);
      setEditingTripEvent(undefined);
  };

  // --- Booking Handlers ---
  const handleSaveBooking = (data: Partial<BookingItem>) => {
      if (editingBooking) {
          setBookings(bookings.map(b => b.id === editingBooking.id ? { ...b, ...data } as BookingItem : b));
      } else {
          const newBooking: BookingItem = {
              id: Date.now().toString(),
              type: data.type || 'hotel',
              ...data
          } as BookingItem;
          setBookings([...bookings, newBooking]);
      }
      setIsBookingModalOpen(false);
      setEditingBooking(undefined);
  };

  const handleDeleteBooking = () => {
      if (!editingBooking) return;
      setBookings(bookings.filter(b => b.id !== editingBooking.id));
      setIsBookingModalOpen(false);
      setEditingBooking(undefined);
  };

  // --- Expense Handlers ---
  const handleSaveExpense = (data: Partial<ExpenseItem>) => {
      if (editingExpense) {
          setExpenses(expenses.map(e => e.id === editingExpense.id ? { ...e, ...data } as ExpenseItem : e));
      } else {
          const newExpense: ExpenseItem = {
              id: Date.now().toString(),
              date: data.date || selectedDate,
              title: data.title || 'æ–°æ”¯å‡º',
              amount: data.amount || 0,
              currency: data.currency || 'JPY',
              category: data.category || 'other',
              ...data
          } as ExpenseItem;
          setExpenses([...expenses, newExpense]);
      }
      setIsExpenseModalOpen(false);
      setEditingExpense(undefined);
  };

  const handleDeleteExpense = () => {
      if (!editingExpense) return;
      setExpenses(expenses.filter(e => e.id !== editingExpense.id));
      setIsExpenseModalOpen(false);
      setEditingExpense(undefined);
  };

  // --- Must List Handlers ---
  const handleToggleMust = (id: string) => {
      setMustList(mustList.map(item => 
          item.id === id ? { ...item, isCompleted: !item.isCompleted } : item
      ));
  };

  const handleSaveMust = (data: Partial<MustItem>) => {
      if (editingMust) {
          setMustList(mustList.map(item => item.id === editingMust.id ? { ...item, ...data } as MustItem : item));
      } else {
          const newItem: MustItem = {
              id: Date.now().toString(),
              type: data.type || 'eat',
              area: data.area || 'åå¤å±‹',
              name: data.name || '',
              note: data.note || '',
              location: data.location || '',
              isCompleted: false,
              ...data
          } as MustItem;
          setMustList([...mustList, newItem]);
      }
      setIsMustModalOpen(false);
      setEditingMust(undefined);
  };

  const handleDeleteMust = () => {
      if (!editingMust) return;
      setMustList(mustList.filter(item => item.id !== editingMust.id));
      setIsMustModalOpen(false);
      setEditingMust(undefined);
  };

  // --- Global FAB Handler ---
  const handleFabClick = () => {
      switch(activeTab) {
          case 'schedule':
              setEditingTripEvent(undefined);
              setIsTripModalOpen(true);
              break;
          case 'bookings':
              setEditingBooking(undefined);
              setIsBookingModalOpen(true);
              break;
          case 'expense':
              setEditingExpense(undefined);
              setIsExpenseModalOpen(true);
              break;
          case 'plan':
              setEditingMust(undefined);
              setIsMustModalOpen(true);
              break;
          default:
              break;
      }
  };

  const getFabLabel = () => {
      switch(activeTab) {
          case 'schedule': return 'æ–°å¢è¡Œç¨‹';
          case 'bookings': return 'æ–°å¢é è¨‚';
          case 'expense': return 'æ–°å¢æ”¯å‡º';
          case 'plan': return 'æ–°å¢å¿…è²·å¿…åƒ';
          default: return 'æ–°å¢';
      }
  };

  const renderContent = () => {
      switch(activeTab) {
          case 'schedule':
              return (
                <SchedulePage 
                    tripData={tripData}
                    selectedDate={selectedDate}
                    setSelectedDate={setSelectedDate}
                    updateEventsForDay={updateEventsForDay}
                    openModal={() => setIsTripModalOpen(true)} 
                    setEditingEvent={setEditingTripEvent} 
                />
              );
          case 'bookings':
              return (
                <BookingsPage 
                    bookings={bookings} 
                    onEdit={(item) => { setEditingBooking(item); setIsBookingModalOpen(true); }}
                />
              );
          case 'expense':
              return (
                  <ExpensePage 
                      expenses={expenses}
                      exchangeRate={exchangeRate}
                      setExchangeRate={setExchangeRate}
                      onEdit={(item) => { setEditingExpense(item); setIsExpenseModalOpen(true); }}
                      onAdd={() => { setEditingExpense(undefined); setIsExpenseModalOpen(true); }}
                  />
              );
          case 'plan':
              return (
                  <MustListPage 
                      items={mustList}
                      onToggle={handleToggleMust}
                      onEdit={(item) => { setEditingMust(item); setIsMustModalOpen(true); }}
                  />
              );
          default:
              return null;
      }
  };

  return (
    <Layout activeTab={activeTab} onTabChange={setActiveTab}>
      {renderContent()}
      
      {/* Global Wide FAB */}
      <button 
        onClick={handleFabClick}
        className="absolute bottom-24 left-5 right-5 h-12 bg-[#FF8C42] rounded-2xl shadow-lg flex items-center justify-center text-white font-bold gap-2 active:scale-95 transition-all z-40"
      >
          <Plus size={20} strokeWidth={3} />
          {getFabLabel()}
      </button>

      {/* Schedule Modal */}
      <TripModal 
         isOpen={isTripModalOpen}
         onClose={() => setIsTripModalOpen(false)}
         onSave={handleSaveTripEvent}
         onDelete={handleDeleteTripEvent}
         initialData={editingTripEvent}
      />

      {/* Booking Modal */}
      <BookingModal 
         isOpen={isBookingModalOpen}
         onClose={() => setIsBookingModalOpen(false)}
         onSave={handleSaveBooking}
         onDelete={handleDeleteBooking}
         initialData={editingBooking}
      />

      {/* Expense Modal */}
      <ExpenseModal 
          isOpen={isExpenseModalOpen}
          onClose={() => setIsExpenseModalOpen(false)}
          onSave={handleSaveExpense}
          onDelete={handleDeleteExpense}
          initialData={editingExpense}
      />

      {/* Must Modal */}
      <MustModal
          isOpen={isMustModalOpen}
          onClose={() => setIsMustModalOpen(false)}
          onSave={handleSaveMust}
          onDelete={handleDeleteMust}
          initialData={editingMust}
      />
    </Layout>
  );
}