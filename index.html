<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>李家名古屋 伊勢志摩之旅</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ise: {
                            base: '#F4F6F8', // 極簡灰白底
                            blue: '#1e3a5f', // 伊勢深藍
                            accent: '#A59ACA', // 藤花紫點綴
                            gold: '#C5A059', // 參拜金
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F0F2F5; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; display: flex; justify-content: center; min-height: 100vh; }
        #app-container { width: 100%; max-width: 430px; background-color: #FAFAFA; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 15px rgba(30, 58, 95, 0.06); }
        .header-curve { border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; }
        .nav-item { transition: all 0.2s ease; }
        .nav-item:active { transform: scale(0.9); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>

<div id="app" class="w-full h-full">
    <div id="app-container" class="relative pb-24 mx-auto bg-gray-50">

        <!-- 頁首區塊 -->
        <header class="bg-ise-blue text-white header-curve relative h-64 shadow-lg overflow-hidden shrink-0">
            <div class="absolute inset-0 opacity-40 bg-[url('https://images.unsplash.com/photo-1545569341-9eb8b30979d9?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center mix-blend-overlay"></div>
            
            <div class="relative z-10 p-6 pt-12">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold tracking-widest mb-1 leading-snug">李家名古屋<br>伊勢志摩之旅</h1>
                        <p class="text-xs opacity-80 font-light tracking-[0.2em] uppercase mt-1">Mie Prefecture Trip</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- 同步狀態燈號 -->
                        <div class="flex items-center bg-black/20 rounded-full px-2 py-1">
                            <div :class="['w-2 h-2 rounded-full mr-1', isConnected ? 'bg-green-400' : 'bg-red-400 animate-pulse']"></div>
                            <span class="text-[10px]">{{ isConnected ? '已同步' : '離線' }}</span>
                        </div>
                        <button @click="toggleEditMode" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all', isEditMode ? 'bg-white text-ise-blue shadow-lg scale-110' : 'bg-white/20 text-white hover:bg-white/30']">
                            <i :class="isEditMode ? 'fa-solid fa-check' : 'fa-solid fa-pen'"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 設定提示 -->
        <div v-if="showConfigAlert" class="absolute inset-0 z-50 bg-slate-800/90 flex items-center justify-center p-6 text-center text-white backdrop-blur-sm">
            <div>
                <i class="fa-solid fa-database text-5xl mb-4 text-ise-gold"></i>
                <h2 class="text-xl font-bold mb-2">請設定 Firebase</h2>
                <p class="text-sm opacity-80 mb-6 leading-relaxed">
                    請確認程式碼中已填入正確的 Firebase Config。
                </p>
            </div>
        </div>

        <!-- 主內容區塊 -->
        <main class="-mt-10 relative z-10 px-5 min-h-[60vh] pb-8">
            
            <!-- TAB 1: 每日行程 -->
            <div v-if="currentTab === 'itinerary'">
                <div class="flex overflow-x-auto hide-scrollbar space-x-3 py-4 mb-2 pb-6">
                    <div v-for="(day, index) in itineraryData" :key="index" 
                         @click="selectedDateIndex = index"
                         :class="['flex-shrink-0 flex flex-col items-center justify-center w-[4.5rem] h-20 rounded-2xl transition-all cursor-pointer card-shadow border duration-300', selectedDateIndex === index ? 'bg-ise-blue text-white border-ise-blue translate-y-1 shadow-inner' : 'bg-white text-gray-400 border-white hover:bg-gray-50']">
                        <span class="text-[10px] font-medium tracking-wide mb-1">{{ day.dayOfWeek }}</span>
                        <span class="text-2xl font-bold font-mono">{{ day.date.split('/')[1] }}</span>
                    </div>
                </div>

                <!-- 天氣 Widget (整合 Open-Meteo API) -->
                <div class="bg-white rounded-3xl p-5 mb-6 flex items-center justify-between card-shadow border border-gray-100">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-ise-gold/10 flex items-center justify-center text-ise-gold text-2xl relative">
                            <i :class="getWeatherIcon(currentWeather.code)" class="transition-all duration-500"></i>
                            <div v-if="weatherLoading" class="absolute inset-0 flex items-center justify-center bg-white/80 rounded-full"><i class="fa-solid fa-circle-notch fa-spin text-xs"></i></div>
                        </div>
                        <div>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-3xl font-bold text-slate-800">{{ currentWeather.temp }}°</span>
                                <span class="text-sm text-gray-400">{{ currentWeather.text }}</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-0.5 flex items-center">
                                <i class="fa-solid fa-location-dot mr-1 text-ise-blue/50"></i>
                                {{ itineraryData[selectedDateIndex].mainLocationName }} (即時)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pb-28">
                    <transition-group name="fade">
                        <div v-for="(item, idx) in currentDayItinerary" :key="item.id" 
                             class="group relative bg-white rounded-2xl p-5 card-shadow border-l-[6px] transition-all hover:scale-[1.01] active:scale-[0.99]"
                             :class="[getCategoryBorderColor(item.category), isEditMode ? '' : '']">
                            
                            <div v-if="isEditMode" class="absolute -top-3 -right-2 z-20 flex space-x-2">
                                <button @click.stop="openEditModal(item, idx, 'itinerary')" class="w-8 h-8 rounded-full bg-ise-blue text-white shadow-md flex items-center justify-center hover:bg-blue-600"><i class="fa-solid fa-pencil text-xs"></i></button>
                                <button @click.stop="requestDelete(item.id, 'itinerary')" class="w-8 h-8 rounded-full bg-red-500 text-white shadow-md flex items-center justify-center hover:bg-red-600"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                            <div v-if="isEditMode" class="absolute top-1/2 -translate-y-1/2 -left-3 z-20 flex flex-col bg-white shadow-md rounded-lg overflow-hidden border border-gray-200">
                                <button @click.stop="moveItem(idx, -1)" v-if="idx > 0" class="p-1 hover:bg-gray-100 text-ise-blue"><i class="fa-solid fa-caret-up"></i></button>
                                <button @click.stop="moveItem(idx, 1)" v-if="idx < currentDayItinerary.length - 1" class="p-1 hover:bg-gray-100 text-ise-blue"><i class="fa-solid fa-caret-down"></i></button>
                            </div>

                            <div v-if="item.category === '航班'" class="pr-8">
                                <div class="flex justify-between items-center mb-4"><span class="bg-ise-blue text-white text-[10px] px-2 py-1 rounded font-bold tracking-wider">{{ item.category }}</span><span class="text-sm font-bold text-ise-blue font-mono">{{ item.subTitle }}</span></div>
                                <div class="flex justify-between items-center px-2">
                                    <div class="text-center"><div class="text-2xl font-bold text-slate-800">{{ item.time.split('➤')[0].trim().split(' ')[0] }}</div><div class="text-xs text-gray-400 font-bold tracking-widest mt-1">TPE</div></div>
                                    <div class="flex-1 px-4 text-center relative"><div class="h-[1px] bg-gray-300 w-full absolute top-1/2 left-0 -z-0"></div><i class="fa-solid fa-plane-departure text-ise-gold bg-white px-2 relative z-10 text-2xl"></i></div>
                                    <div class="text-center"><div class="text-2xl font-bold text-slate-800">{{ item.time.split('➤')[1].trim().split(' ')[0] }}</div><div class="text-xs text-gray-400 font-bold tracking-widest mt-1">NGO</div></div>
                                </div>
                                <div class="mt-4 text-xs text-center text-gray-500 bg-gray-50 py-1 rounded">{{ item.title }}</div>
                                <div v-if="item.story" class="mt-3 bg-amber-50 rounded-lg p-3 border border-amber-100 flex items-start"><i class="fa-solid fa-circle-info text-amber-400 text-xs mt-0.5 mr-2"></i><p class="text-xs text-amber-800 leading-relaxed">{{ item.story }}</p></div>
                                <div class="flex justify-end mt-2" v-if="!isEditMode"><button @click.stop="openMap(item.title)" class="text-xs text-ise-blue flex items-center bg-blue-50 px-2 py-1 rounded-lg hover:bg-blue-100 transition-colors"><i class="fa-solid fa-location-arrow mr-1"></i> 機場導航</button></div>
                            </div>

                            <div v-else class="pr-8">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-2"><span class="text-[10px] font-bold px-2 py-0.5 rounded text-white" :class="getCategoryBadgeColor(item.category)">{{ item.category }}</span><span class="text-sm font-bold text-ise-blue font-mono" v-if="item.time">{{ item.time }}</span></div>
                                    <div v-if="item.mapcode" class="flex items-center bg-gray-100 px-2 py-0.5 rounded text-[10px] text-gray-600 font-mono tracking-wider cursor-pointer" @click.stop="copyToClipboard(item.mapcode)"><i class="fa-solid fa-car-side mr-1"></i>{{ item.mapcode }}</div>
                                </div>
                                <h3 class="text-lg font-bold text-slate-800 mb-1 leading-snug">{{ item.title }}</h3>
                                <div v-if="item.cost" class="flex items-center text-sm text-ise-gold font-bold mb-2"><i class="fa-solid fa-yen-sign mr-1"></i>{{ Number(item.cost).toLocaleString() }}</div>
                                <p class="text-sm text-gray-500 leading-relaxed whitespace-pre-line" v-if="item.desc">{{ item.desc }}</p>
                                <div v-if="item.story" class="mt-3 bg-amber-50 rounded-lg p-3 border border-amber-100 flex items-start"><i class="fa-regular fa-lightbulb text-amber-500 text-xs mt-0.5 mr-2"></i><p class="text-xs text-amber-800 leading-relaxed text-justify">{{ item.story }}</p></div>
                                <div class="flex justify-end mt-2 space-x-2" v-if="!isEditMode"><button @click.stop="openMap(item.address || item.title)" class="text-xs text-ise-blue flex items-center bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors shadow-sm font-bold"><i class="fa-solid fa-location-arrow mr-1"></i> {{ item.address ? '導航' : '地圖' }}</button></div>
                            </div>
                        </div>
                    </transition-group>
                    <div class="h-10 text-center text-gray-300 text-xs italic">- Enjoy your trip -</div>
                </div>
            </div>

            <!-- TAB 2: 資訊頁面 -->
            <div v-if="currentTab === 'info'" class="space-y-6 pb-28 animate-fade-in">
                <div class="bg-white rounded-3xl p-1 card-shadow flex mb-2 mt-4">
                    <button v-for="sub in ['航班', '住宿', '租車']" :key="sub" @click="infoSubTab = sub"
                        :class="['flex-1 py-2 rounded-2xl text-sm font-medium transition-colors', infoSubTab === sub ? 'bg-ise-blue text-white shadow-md' : 'text-gray-400 hover:text-gray-600']">{{ sub }}</button>
                </div>
                <div class="bg-white rounded-3xl p-6 card-shadow min-h-[200px]">
                    <div class="space-y-6">
                        <div v-for="(item, idx) in currentInfoList" :key="item.id" class="relative group border-b border-gray-100 pb-4 last:border-0 last:pb-0">
                            <div v-if="isEditMode" class="absolute right-0 top-0 flex space-x-2 z-10">
                                <button @click="openEditModal(item, idx, 'info')" class="w-7 h-7 bg-ise-blue text-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-pencil text-[10px]"></i></button>
                                <button @click="requestDelete(item.id, 'info')" class="w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-trash text-[10px]"></i></button>
                            </div>
                            <div v-if="infoSubTab === '航班'">
                                <div class="text-xs font-bold text-gray-400 mb-1">{{ item.desc }}</div>
                                <h4 class="text-xl font-bold text-ise-blue">{{ item.title }}</h4>
                                <div class="mt-3 flex justify-between items-center">
                                    <div><div class="text-xl font-bold">{{ item.startTime }}</div><div class="text-xs text-gray-500">{{ item.startLoc }}</div></div>
                                    <i class="fa-solid fa-plane-departure text-gray-300 text-xl"></i>
                                    <div><div class="text-xl font-bold">{{ item.endTime }}</div><div class="text-xs text-gray-500">{{ item.endLoc }}</div></div>
                                </div>
                            </div>
                            <div v-if="infoSubTab === '住宿'">
                                <div class="flex justify-between items-start mb-1"><span class="text-xs font-bold bg-ise-blue/10 text-ise-blue px-2 py-0.5 rounded">{{ item.date }}</span><span class="text-xs text-gray-400">{{ item.type }}</span></div>
                                <h4 class="font-bold text-slate-800 text-base mb-1">{{ item.title }}</h4>
                                <div class="flex justify-between items-end"><div class="text-sm text-gray-500">{{ item.desc }}</div><div class="text-sm font-bold text-ise-gold">{{ item.price }}</div></div>
                                <button @click="openMap(item.title)" class="w-full mt-3 py-2 border border-gray-200 rounded-xl text-xs text-gray-500 hover:bg-gray-50 flex items-center justify-center"><i class="fa-solid fa-location-dot mr-2"></i> 導航前往</button>
                            </div>
                            <div v-if="infoSubTab === '租車'">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-ise-blue border border-gray-100"><i class="fa-solid fa-car"></i></div>
                                    <div><h4 class="font-bold text-slate-800">{{ item.title }}</h4><div class="text-xs text-gray-500">{{ item.subTitle }}</div></div>
                                </div>
                                <p class="text-sm text-gray-600 whitespace-pre-line">{{ item.desc }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: 必吃必買 -->
            <div v-if="currentTab === 'shopping'" class="pb-28">
                <div class="flex overflow-x-auto hide-scrollbar space-x-2 py-2 mb-4 px-1">
                    <button v-for="region in ['全部', '名古屋', '托福橫丁', '伊勢志摩', '其他']" :key="region" @click="shoppingRegion = region" :class="['whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all', shoppingRegion === region ? 'bg-ise-blue text-white shadow-md' : 'bg-white text-gray-400 hover:bg-gray-50']">{{ region }}</button>
                </div>
                <div v-if="filteredShoppingList.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-300"><div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4"><i class="fa-solid fa-utensils text-3xl"></i></div><p>這裡還沒有必吃必買...</p></div>
                <div class="grid grid-cols-1 gap-3">
                    <div v-for="(item, idx) in filteredShoppingList" :key="item.id" class="bg-white rounded-xl p-4 card-shadow relative group hover:scale-[1.01] transition-transform flex flex-col justify-between min-h-[100px]">
                        <div v-if="isEditMode" class="absolute top-2 right-2 z-20 flex space-x-2">
                            <button @click="openEditModal(item, idx, 'shopping')" class="w-7 h-7 bg-ise-blue text-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-pencil text-[10px]"></i></button>
                            <button @click="requestDelete(item.id, 'shopping')" class="w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                        <div>
                            <div class="flex justify-start items-start mb-2"><span class="text-[10px] text-white bg-ise-gold px-2 py-0.5 rounded font-bold">{{ item.region || '未分類' }}</span></div>
                            <h4 class="font-bold text-slate-800 text-lg mb-1">{{ item.name }}</h4>
                            <p class="text-xs text-gray-500 whitespace-pre-line mb-2" v-if="item.desc">{{ item.desc }}</p>
                            <div v-if="item.story" class="mt-2 bg-pink-50 rounded p-2 border border-pink-100 flex items-start"><i class="fa-solid fa-star text-pink-400 text-xs mt-0.5 mr-2"></i><p class="text-xs text-pink-800 leading-relaxed">{{ item.story }}</p></div>
                        </div>
                        <div class="flex justify-end mt-2 pt-2 border-t border-gray-50">
                            <button @click.stop="openMap(item.address || item.name)" class="text-xs text-ise-blue flex items-center font-bold bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100"><i class="fa-solid fa-location-arrow mr-1"></i> {{ item.address ? '導航' : '地圖搜尋' }}</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: 花費紀錄 -->
            <div v-if="currentTab === 'expense'" class="pb-28">
                <div class="bg-gradient-to-br from-ise-blue to-slate-800 rounded-3xl p-6 text-white card-shadow mb-6 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="relative z-10">
                        <div class="text-xs opacity-70 mb-1 uppercase tracking-widest">總花費 (預估台幣)</div>
                        <div class="text-4xl font-bold font-mono tracking-tight mb-4">NT$ {{ expenseStats.final.toLocaleString() }}</div>
                        <div class="flex space-x-3 mb-2">
                            <div class="bg-white/10 backdrop-blur-md px-3 py-2 rounded-lg flex-1"><div class="text-[10px] opacity-60">日幣總和 (JPY)</div><div class="font-bold text-sm">¥{{ expenseStats.jpy.toLocaleString() }}</div></div>
                            <div class="bg-white/10 backdrop-blur-md px-3 py-2 rounded-lg flex-1"><div class="text-[10px] opacity-60">台幣總和 (TWD)</div><div class="font-bold text-sm">NT${{ expenseStats.twd.toLocaleString() }}</div></div>
                        </div>
                        
                        <!-- 手動匯率設定 -->
                        <div class="flex items-center justify-end">
                            <label class="text-[10px] opacity-60 mr-2">匯率設定:</label>
                            <input type="number" step="0.001" v-model="exchangeRate" class="bg-white/20 text-white w-16 text-xs px-2 py-1 rounded text-center outline-none focus:bg-white/30 font-mono">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] min-h-[500px] p-5 -mx-5">
                    <div class="flex justify-between items-center mb-6 px-2"><h3 class="font-bold text-slate-800">近期消費</h3><span class="text-xs text-gray-400">{{ expenses.length }} 筆紀錄</span></div>
                    <div class="space-y-5">
                        <div v-for="(group, date) in expensesByDate" :key="date">
                             <div class="sticky top-0 bg-gray-50/95 backdrop-blur py-2 px-2 text-xs font-bold text-gray-400 z-10">{{ date }}</div>
                             <div v-for="(record, idx) in group" :key="record.id" class="flex items-center justify-between group relative py-3 border-b border-gray-50 last:border-0">
                                <div v-if="isEditMode" class="absolute -right-2 top-1/2 -translate-y-1/2 flex space-x-2 z-10 bg-white pl-2">
                                     <button @click="openEditModal(record, idx, 'expense')" class="w-8 h-8 rounded-full bg-ise-blue text-white shadow flex items-center justify-center"><i class="fa-solid fa-pencil text-xs"></i></button>
                                     <button @click="requestDelete(record.id, 'expense')" class="w-8 h-8 rounded-full bg-red-500 text-white shadow flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div>
                                        <div class="font-bold text-slate-800 text-sm flex items-center"><span class="text-[10px] text-ise-blue bg-blue-50 px-1.5 py-0.5 rounded mr-2 font-normal">{{ record.category }}</span>{{ record.name }}</div>
                                        <div class="text-[10px] text-gray-400 mt-0.5 ml-1">{{ record.payment }}</div>
                                    </div>
                                </div>
                                <div class="text-right" :class="isEditMode ? 'opacity-20' : ''">
                                    <div class="font-bold text-slate-800 font-mono text-sm"><span v-if="record.currency === 'TWD'" class="text-xs">NT$</span><span v-else>¥</span>{{ Number(record.amount).toLocaleString() }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="expenses.length === 0" class="text-center py-10 text-gray-300 text-sm">尚未有記帳紀錄</div>
                </div>
            </div>
        </main>

        <div class="fixed bottom-0 left-0 right-0 mx-auto w-full max-w-[430px] bg-white border-t border-gray-100 flex justify-around items-end h-[88px] pb-6 z-40 text-xs shadow-[0_-5px_20px_rgba(0,0,0,0.03)] px-2">
            <button @click="currentTab = 'itinerary'" class="nav-item flex flex-col items-center justify-center w-16 space-y-1" :class="currentTab === 'itinerary' ? 'text-ise-blue' : 'text-gray-400 hover:text-gray-500'"><div :class="['w-10 h-8 rounded-xl flex items-center justify-center mb-1 transition-colors', currentTab === 'itinerary' ? 'bg-blue-50' : 'bg-transparent']"><i class="fa-solid fa-map-location-dot text-xl"></i></div><span class="scale-90 font-medium">行程</span></button>
            <button @click="currentTab = 'info'" class="nav-item flex flex-col items-center justify-center w-16 space-y-1" :class="currentTab === 'info' ? 'text-ise-blue' : 'text-gray-400 hover:text-gray-500'"><div :class="['w-10 h-8 rounded-xl flex items-center justify-center mb-1 transition-colors', currentTab === 'info' ? 'bg-blue-50' : 'bg-transparent']"><i class="fa-solid fa-circle-info text-xl"></i></div><span class="scale-90 font-medium">資訊</span></button>
            <button @click="openAddModal" class="w-14 h-14 rounded-full bg-ise-blue text-white shadow-lg flex items-center justify-center text-xl mb-2 hover:scale-105 transition-transform active:scale-95 mx-2"><i class="fa-solid fa-plus"></i></button>
            <button @click="currentTab = 'expense'" class="nav-item flex flex-col items-center justify-center w-16 space-y-1" :class="currentTab === 'expense' ? 'text-ise-blue' : 'text-gray-400 hover:text-gray-500'"><div :class="['w-10 h-8 rounded-xl flex items-center justify-center mb-1 transition-colors', currentTab === 'expense' ? 'bg-blue-50' : 'bg-transparent']"><i class="fa-solid fa-coins text-xl"></i></div><span class="scale-90 font-medium">記帳</span></button>
            <button @click="currentTab = 'shopping'" class="nav-item flex flex-col items-center justify-center w-16 space-y-1" :class="currentTab === 'shopping' ? 'text-ise-blue' : 'text-gray-400 hover:text-gray-500'"><div :class="['w-10 h-8 rounded-xl flex items-center justify-center mb-1 transition-colors', currentTab === 'shopping' ? 'bg-blue-50' : 'bg-transparent']"><i class="fa-solid fa-utensils text-xl"></i></div><span class="scale-90 font-medium">必吃必買</span></button>
        </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div v-if="showDeleteModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-center justify-center p-6 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-xs p-6 text-center shadow-2xl scale-100">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-trash-can"></i></div>
            <h3 class="font-bold text-lg text-slate-800 mb-2">確認刪除</h3>
            <p class="text-sm text-gray-500 mb-6">刪除後將無法復原，確定要繼續嗎？</p>
            <div class="flex space-x-3"><button @click="showDeleteModal = false" class="flex-1 py-2.5 bg-gray-100 text-gray-600 font-medium rounded-xl">取消</button><button @click="executeDelete" class="flex-1 py-2.5 bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-200">刪除</button></div>
        </div>
    </div>

    <!-- 行程 Modal -->
    <div v-if="showAddModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-slide-up max-h-[85vh] overflow-y-auto hide-scrollbar">
            <h3 class="font-bold text-xl mb-4 text-slate-800">{{ editIndex !== null ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2"><button v-for="cat in ['景點','美食','購物','住宿','其他']" @click="newItem.category = cat" :class="['py-2 text-sm rounded-xl font-medium border', newItem.category === cat ? 'bg-ise-blue text-white border-ise-blue' : 'bg-white text-gray-500 border-gray-200']">{{ cat }}</button></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">名稱</label><input v-model="newItem.title" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20" placeholder="要去哪裡？"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">MAPCODE</label><input v-model="newItem.mapcode" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20 font-mono" placeholder="自駕導航用"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">導航地址</label><input v-model="newItem.address" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20" placeholder="輸入地址以啟用精準導航"></div>
                <div class="flex space-x-3">
                    <div class="flex-1 space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">時間</label><input type="time" v-model="newItem.time" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20"></div>
                    <div class="flex-1 space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">費用 (日幣)</label><input type="number" v-model="newItem.cost" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20" placeholder="0"></div>
                </div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">小知識/攻略</label><textarea v-model="newItem.story" class="w-full bg-gray-50 p-3 rounded-xl h-20 outline-none focus:ring-2 focus:ring-ise-blue/20 resize-none" placeholder="必看亮點或歷史故事..."></textarea></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">備註</label><textarea v-model="newItem.desc" class="w-full bg-gray-50 p-3 rounded-xl h-20 outline-none focus:ring-2 focus:ring-ise-blue/20 resize-none" placeholder="詳細資訊..."></textarea></div>
            </div>
            <div class="flex space-x-3 mt-8"><button @click="showAddModal = false" class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-50">取消</button><button @click="saveItineraryItem" class="flex-1 py-3 bg-ise-blue text-white font-bold rounded-xl shadow-lg">{{ editIndex !== null ? '更新' : '新增' }}</button></div>
        </div>
    </div>

    <!-- 資訊 Modal -->
    <div v-if="showInfoModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
         <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-xl mb-4 text-slate-800">{{ editIndex !== null ? '編輯' + infoSubTab : '新增' + infoSubTab }}</h3>
            <div v-if="infoSubTab === '航班'" class="space-y-4">
                <input v-model="newInfo.title" placeholder="航班編號" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <input v-model="newInfo.desc" placeholder="日期說明" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <div class="flex space-x-2"><input v-model="newInfo.startTime" type="time" class="flex-1 bg-gray-50 p-3 rounded-xl"><input v-model="newInfo.startLoc" placeholder="出發地" class="flex-1 bg-gray-50 p-3 rounded-xl"></div>
                <div class="flex space-x-2"><input v-model="newInfo.endTime" type="time" class="flex-1 bg-gray-50 p-3 rounded-xl"><input v-model="newInfo.endLoc" placeholder="抵達地" class="flex-1 bg-gray-50 p-3 rounded-xl"></div>
            </div>
            <div v-if="infoSubTab === '住宿'" class="space-y-4">
                <input v-model="newInfo.title" placeholder="飯店名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <div class="flex space-x-2"><input v-model="newInfo.date" placeholder="日期" class="flex-1 bg-gray-50 p-3 rounded-xl"><input v-model="newInfo.type" placeholder="訂房網" class="flex-1 bg-gray-50 p-3 rounded-xl"></div>
                <div class="flex space-x-2"><input v-model="newInfo.desc" placeholder="房型說明" class="flex-1 bg-gray-50 p-3 rounded-xl"><input v-model="newInfo.price" placeholder="價格" class="flex-1 bg-gray-50 p-3 rounded-xl"></div>
            </div>
            <div v-if="infoSubTab === '租車'" class="space-y-4">
                <input v-model="newInfo.title" placeholder="公司名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <input v-model="newInfo.subTitle" placeholder="分店名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <textarea v-model="newInfo.desc" placeholder="詳細資訊" class="w-full bg-gray-50 p-3 rounded-xl h-24"></textarea>
            </div>
            <div class="flex space-x-3 mt-8"><button @click="showInfoModal = false" class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-50">取消</button><button @click="saveInfoItem" class="flex-1 py-3 bg-ise-blue text-white font-bold rounded-xl shadow-lg">{{ editIndex !== null ? '更新' : '新增' }}</button></div>
         </div>
    </div>

    <!-- 購物 Modal -->
    <div v-if="showShoppingModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-slide-up max-h-[85vh] overflow-y-auto hide-scrollbar">
            <h3 class="font-bold text-xl mb-4 text-slate-800">{{ editIndex !== null ? '編輯項目' : '新增必吃/必買' }}</h3>
            <div class="space-y-4">
                <select v-model="newShoppingItem.region" class="w-full bg-gray-50 p-3 rounded-xl outline-none border border-transparent focus:border-ise-blue text-slate-700">
                    <option v-for="r in ['名古屋', '托福橫丁', '伊勢志摩', '其他']" :value="r">{{ r }}</option>
                </select>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">名稱</label><input v-model="newShoppingItem.name" placeholder="商品/餐廳名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20 text-lg"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">地址</label><input v-model="newShoppingItem.address" placeholder="輸入地址或Google Map連結" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-blue/20"></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">推薦點/故事</label><textarea v-model="newShoppingItem.story" class="w-full bg-gray-50 p-3 rounded-xl h-20 outline-none focus:ring-2 focus:ring-ise-blue/20 resize-none" placeholder="為什麼必買？歷史典故..."></textarea></div>
                <div class="space-y-2"><label class="text-xs font-bold text-gray-400 ml-1">備註</label><textarea v-model="newShoppingItem.desc" placeholder="營業時間、必點菜色..." class="w-full bg-gray-50 p-3 rounded-xl h-20 outline-none focus:ring-2 focus:ring-ise-blue/20 resize-none"></textarea></div>
            </div>
            <div class="flex space-x-3 mt-8"><button @click="showShoppingModal = false" class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-50">取消</button><button @click="saveShoppingItem" class="flex-1 py-3 bg-ise-blue text-white font-bold rounded-xl shadow-lg">{{ editIndex !== null ? '更新' : '加入' }}</button></div>
        </div>
    </div>

    <!-- 花費 Modal -->
    <div v-if="showExpenseModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-slide-up">
            <h3 class="font-bold text-xl mb-4 text-slate-800">{{ editIndex !== null ? '修改紀錄' : '記一筆' }}</h3>
            <div class="space-y-4">
                <!-- 新增日期選擇欄位 -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-400 ml-1">日期</label>
                    <select v-model="newExpense.date" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-gold/20 text-slate-800">
                         <option v-for="day in itineraryData" :key="day.date" :value="day.date">
                             {{ day.date }} {{ day.dayOfWeek }}
                         </option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1 flex bg-gray-100 p-1 rounded-xl"><button v-for="curr in ['JPY','TWD']" @click="newExpense.currency = curr" :class="['flex-1 py-2 text-sm font-medium rounded-lg transition-all', newExpense.currency === curr ? 'bg-white text-ise-blue shadow-sm' : 'text-gray-400']">{{ curr }}</button></div>
                    <div class="flex-[1.5] flex bg-gray-100 p-1 rounded-xl overflow-hidden"><button v-for="pay in ['現金','信用卡','西瓜卡']" @click="newExpense.payment = pay" :class="['flex-1 py-2 text-xs font-medium rounded-lg transition-all whitespace-nowrap', newExpense.payment === pay ? 'bg-white text-slate-800 shadow-sm' : 'text-gray-400']">{{ pay }}</button></div>
                </div>
                <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">{{ newExpense.currency === 'TWD' ? 'NT$' : '¥' }}</span><input v-model="newExpense.amount" type="number" placeholder="0" class="w-full bg-gray-50 p-4 pl-14 rounded-xl outline-none focus:ring-2 focus:ring-ise-gold/20 text-2xl font-bold text-slate-800"></div>
                <input v-model="newExpense.name" placeholder="項目名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-ise-gold/20">
                <div class="grid grid-cols-3 gap-2"><button v-for="cat in ['交通','飲食','住宿','門票','購物','其他']" @click="newExpense.category = cat" :class="['py-2 text-xs rounded-lg border', newExpense.category === cat ? 'bg-ise-gold text-white border-ise-gold' : 'bg-white text-gray-400 border-gray-200']">{{ cat }}</button></div>
            </div>
            <div class="flex space-x-3 mt-8"><button @click="showExpenseModal = false" class="flex-1 py-3 text-gray-500 font-medium rounded-xl hover:bg-gray-50">取消</button><button @click="saveExpense" class="flex-1 py-3 bg-ise-gold text-white font-bold rounded-xl shadow-lg">{{ editIndex !== null ? '更新' : '儲存' }}</button></div>
        </div>
    </div>

</div>
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // --------------------------------------------------------
    // 【設定區】請在這裡貼上你的 Firebase Config
    // --------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyACvNeKGANgue9dsAXHbsJWVIX_3QGVZV8",
        authDomain: "nagoya-9c1cd.firebaseapp.com",
        projectId: "nagoya-9c1cd",
        storageBucket: "nagoya-9c1cd.firebasestorage.app",
        messagingSenderId: "1058096372648",
        appId: "1:1058096372648:web:0d7afa5e2b63f2b62e9b9d"
    };

    let db = null;

    // 定義輔助函式 (Move helpers here to avoid ReferenceError)
    const getCategoryIcon = (cat) => {
        const map = {
            '交通': { icon: 'fa-train', bg: 'bg-blue-400' },
            '飲食': { icon: 'fa-utensils', bg: 'bg-orange-400' },
            '住宿': { icon: 'fa-bed', bg: 'bg-indigo-400' },
            '購物': { icon: 'fa-bag-shopping', bg: 'bg-pink-400' },
            '門票': { icon: 'fa-ticket', bg: 'bg-green-400' },
            '景點': { icon: 'fa-camera', bg: 'bg-green-500' },
            '其他': { icon: 'fa-circle', bg: 'bg-gray-400' }
        };
        return map[cat] || map['其他'];
    };

    const getWeatherIcon = (code) => {
        if (code === 0) return 'fa-solid fa-sun text-ise-gold';
        if (code <= 3) return 'fa-solid fa-cloud-sun text-gray-400';
        if (code <= 48) return 'fa-solid fa-smog text-gray-300';
        if (code <= 57) return 'fa-solid fa-cloud-rain text-blue-300';
        if (code <= 67) return 'fa-solid fa-cloud-showers-heavy text-blue-500';
        if (code <= 77) return 'fa-solid fa-snowflake text-sky-200';
        if (code <= 82) return 'fa-solid fa-cloud-rain text-blue-400';
        return 'fa-solid fa-bolt text-yellow-500';
    };

    const mapWmoCode = (code) => {
        const codes = { 0: '晴朗', 1: '多雲', 2: '多雲', 3: '陰天', 45: '霧', 48: '霧', 51: '毛毛雨', 53: '小雨', 55: '大雨', 61: '小雨', 63: '中雨', 65: '大雨', 71: '小雪', 73: '中雪', 75: '大雪', 80: '陣雨', 95: '雷雨' };
        return codes[code] || '未知';
    };

    const getCategoryBorderColor = (cat) => {
        const map = { '交通': 'border-blue-400', '航班': 'border-blue-600', '飲食': 'border-orange-400', '住宿': 'border-indigo-400', '購物': 'border-pink-400', '景點': 'border-green-500', '其他': 'border-gray-300' };
        return map[cat] || map['其他'];
    };

    const getCategoryBadgeColor = (cat) => {
        const map = { '交通': 'bg-blue-400', '飲食': 'bg-orange-400', '住宿': 'bg-indigo-400', '購物': 'bg-pink-400', '景點': 'bg-green-500', '其他': 'bg-gray-400' };
        return map[cat] || map['其他'];
    };

    // 預設資料 (初始化用)
    const defaultItinerary = [
                {
                    date: '1/14', dayOfWeek: 'TUE', location: '桃園 ➤ 名古屋', mainLocationName: '中部國際機場', lat: 34.858, lon: 136.805,
                    items: [
                        { id: 101, category: '航班', title: '前往中部國際機場', subTitle: 'JL8670', time: '15:50 ➤ 19:25', story: '日航服務周到，建議提前2小時抵達機場。' },
                        { id: 102, category: '租車', title: '日産レンタカー中部国際空港', time: '20:00', desc: '預約號：RC22460954665223760\n車型：セレナe-POWER\n費用：¥88,902', cost: 88902, address: '日産レンタカー中部国際空港店', mapcode: '371 697 049*44', story: '位於Access Plaza 2樓，辦理手續需備妥駕照與日文譯本。' },
                        { id: 103, category: '住宿', title: 'Hotel Castle Inn Tsu', desc: '前往飯店 Check-in\nBooking 含早 兩間客房', cost: 15496, story: '位於津市的平價商務飯店，適合自駕中繼休息。' }
                    ]
                },
                {
                    date: '1/15', dayOfWeek: 'WED', location: '津 ➤ 松阪 ➤ 志摩', mainLocationName: '松阪市', lat: 34.577, lon: 136.536,
                    items: [
                        { id: 201, category: '交通', title: '前往松阪', time: '09:00', desc: '停車: よいほモール第６駐車場', address: 'よいほモール第６駐車場', mapcode: '80 288 027*33', story: '車程約30分鐘，建議停在市中心方便步行。' },
                        { id: 202, category: '景點', title: '豪商的城市觀光交流中心', time: '10:00', desc: '觀光資訊、松阪歷史文化介紹\n2F 放映室有英文字幕', mapcode: '80 288 027*33', story: '了解松阪商人歷史的最佳起點，建築本身也很有特色。' },
                        { id: 203, category: '景點', title: '松阪木棉手織中心', desc: '體驗傳統工藝品、藍色木棉布', mapcode: '80 288 027*33', story: '江戶時代風靡一時的「松阪縞」，藍染條紋非常典雅。' },
                        { id: 204, category: '景點', title: '舊小津清左衛門家', cost: 200, desc: '富商宅邸參觀、萬兩銀箱', mapcode: '80 289 064*11', story: '紙業大亨的豪宅，可見識到江戶富商的奢華生活。' },
                        { id: 205, category: '景點', title: '松坂城跡', desc: '欣賞石垣與城市風景', mapcode: '80 258 791*02', story: '雖無天守閣，但壯觀的石牆被稱為「石垣的博物館」。' },
                        { id: 206, category: '景點', title: '御城番屋敷', desc: '國家指定重要文化財', mapcode: '80 258 791*02', story: '這是當年守護松坂城的武士住宅，至今仍有人居住，非常罕見。' },
                        { id: 207, category: '美食', title: '一升瓶 本店 (松阪牛)', time: '午餐', desc: '燒肉老店\n旋轉燒肉創始店', address: '一升びん本店', mapcode: '80 229 821*58', story: '松阪牛的必吃名店，旋轉燒肉形式有趣且價格相對親民。' },
                        { id: 208, category: '景點', title: '横山展望台', time: '14:00', desc: '眺望英虞灣谷灣海岸\n天空咖啡露台', mapcode: '338 058 634*55', story: '米其林一星景點，能一覽英虞灣60多個小島的絕美景色。' },
                        { id: 209, category: '景點', title: '大王崎燈塔', desc: '視時間決定\n日本燈塔50選', story: '被稱為「繪畫之鎮」，是許多畫家喜愛的寫生地點。' },
                        { id: 210, category: '住宿', title: '志摩観光ホテル ザ ベイスイート', time: 'Check-in', desc: '一休 含早 4名1室', cost: 92640, mapcode: '338 188 485*82', story: 'G7伊勢志摩高峰會的舉辦地，頂級服務與海景是其賣點。' }
                    ]
                },
                {
                    date: '1/16', dayOfWeek: 'THU', location: '志摩 ➤ 鳥羽', mainLocationName: '鳥羽市', lat: 34.482, lon: 136.843,
                    items: [
                        { id: 301, category: '其他', title: '飯店早餐', time: '07:00' },
                        { id: 302, category: '其他', title: '館內導覽', time: '09:00', desc: '歷史體驗約40分鐘、G7高峰會場' },
                        { id: 303, category: '其他', title: '英虞灣周遊郵輪', time: '11:15', desc: '海洋計程車 (約45分)' },
                        { id: 304, category: '景點', title: '神明神社 (石神さん)', desc: '女性祈願聖地\n必買格子星星御守', mapcode: '338 468 534*36', story: '傳說只要是女性來祈求，就能實現一個願望，非常靈驗。' },
                        { id: 305, category: '美食', title: '海女小屋吃午餐', time: '13:15', desc: '體驗海女文化 ¥31,900/4人\n吃現烤海鮮', cost: 31900, address: '海女小屋はちまんかまど', mapcode: '338 498 155*37', story: '與現役海女圍著火爐聊天，品嚐她們親手捕撈燒烤的新鮮海產。' },
                        { id: 306, category: '景點', title: '珍珠博物館', time: '15:00', desc: '御木本真珠島\n15:30看海女表演', mapcode: '118 536 568*71', story: '世界首次成功養殖珍珠之地，海女表演展現傳統素潛技術。' },
                        { id: 307, category: '住宿', title: '鳥羽国際ホテル 潮路亭', time: 'Check-in', desc: '一休 含早 2名2室\n連住兩晚', cost: 142662, mapcode: '118 566 395*48', story: '以「珍珠極光浴」聞名，溫泉中含有珍珠粉，能讓肌膚閃閃發亮。' }
                    ]
                },
                {
                    date: '1/17', dayOfWeek: 'FRI', location: '伊勢神宮', mainLocationName: '伊勢市', lat: 34.487, lon: 136.709,
                    items: [
                        { id: 401, category: '其他', title: '飯店早餐', time: '07:00' },
                        { id: 402, category: '景點', title: '伊勢神宮-豐受大神宮 (外宮)', time: '10:00', desc: '外宮先祭原則', mapcode: '118 549 081*58', story: '供奉衣食住守護神「豐受大御神」。參拜禮儀是左側通行。' },
                        { id: 403, category: '景點', title: '月夜見宮', desc: '別宮 (視時間)' },
                        { id: 404, category: '景點', title: '伊勢神宮-皇大神宮 (內宮)', time: '11:00', desc: '供奉天照大御神\n日本精神故鄉', mapcode: '118 432 193*65', story: '日本地位最高的神社。跨過宇治橋象徵從凡界進入聖界。' },
                        { id: 405, category: '美食', title: '托福橫丁', time: '午餐', desc: '赤福、伊勢烏龍麵、豚捨可樂餅', mapcode: '118 462 121*67', story: '重現江戶時代伊勢路風情的商店街，充滿復古熱鬧的氣氛。' },
                        { id: 406, category: '景點', title: '伊勢志摩天空道路', time: '14:00', desc: '朝熊山展望台足湯、天空郵筒', mapcode: '118 440 666*26', story: '可以一邊泡著足湯，一邊眺望伊勢灣的絕景兜風路線。' },
                        { id: 407, category: '景點', title: '金剛證寺', desc: '守護伊勢神宮鬼門', story: '「參拜伊勢若不登朝熊，如同入佛門而不誦經」，與神宮關係密切。' },
                        { id: 408, category: '景點', title: '夫婦岩', desc: '二見興玉神社\n祈求良緣', mapcode: '118 620 661*66', story: '大注連繩連結兩塊岩石，象徵夫婦圓滿與良緣，日出美景著名。' },
                        { id: 409, category: '住宿', title: '鳥羽国際ホテル 潮路亭', desc: '續住' }
                    ]
                },
                {
                    date: '1/18', dayOfWeek: 'SAT', location: '鳥羽 ➤ 名古屋', mainLocationName: '名古屋市', lat: 35.181, lon: 136.906,
                    items: [
                        { id: 501, category: '景點', title: '鳥羽水族館', desc: '飼養種類日本第一\n視時間決定是否入內', mapcode: '118 536 442*83', story: '日本唯一飼養儒艮（美人魚原型）的水族館，展區非常豐富。' },
                        { id: 502, category: '景點', title: '豐田產業技術紀念館', time: '13:00', desc: '名古屋市西区', mapcode: '4 345 524*32', story: '從紡織機到汽車，見證TOYOTA集團的發展史，互動性極高。' },
                        { id: 503, category: '住宿', title: 'Comfort Hotel Nagoya Kanayama', desc: '金山站附近\n32000點數換房', cost: 5504, mapcode: '4 169 731*37' },
                        { id: 504, category: '美食', title: '名古屋晚餐', desc: '放完行李後外出覓食' }
                    ]
                },
                {
                    date: '1/19', dayOfWeek: 'SUN', location: '名古屋市區', mainLocationName: '名古屋市', lat: 35.181, lon: 136.906,
                    items: [
                        { id: 601, category: '美食', title: '名古屋早餐體驗', time: '08:00', desc: '點飲料送吐司文化', story: '名古屋獨特的「Morning Service」，點咖啡就送厚片吐司與水煮蛋。' },
                        { id: 602, category: '景點', title: '名古屋城', time: '09:30', desc: '本丸御殿、金鯱', mapcode: '4 348 601*15', story: '屋頂上的金鯱是名古屋的象徵。本丸御殿金碧輝煌，極盡奢華。' },
                        { id: 603, category: '景點', title: '大須觀音寺', desc: '參拜觀音', mapcode: '4 258 827*14', story: '藏有國寶古事記抄本，是當地的信仰中心，紅色建築很搶眼。' },
                        { id: 604, category: '購物', title: '大須商店街', desc: '逛街、古著、電子產品', story: '混合了次文化、古著、美食與電器的商店街，有各種異國料理。' },
                        { id: 605, category: '景點', title: '熱田神宮', desc: '三神器之一 草薙劍', mapcode: '4 139 791*44', story: '供奉傳說中的三神器之一「草薙劍」，地位僅次於伊勢神宮。' }
                    ]
                },
                {
                    date: '1/20', dayOfWeek: 'MON', location: '名古屋 ➤ 常滑', mainLocationName: '常滑市', lat: 34.889, lon: 136.834,
                    items: [
                        { id: 701, category: '景點', title: '角久八丁味噌', time: '10:30', desc: '岡崎市\n參觀味噌工廠', story: 'NHK晨間劇取景地，可以參觀傳統味噌木桶，品嚐紅味噌湯。' },
                        { id: 702, category: '其他', title: '西尾抹茶博物館', time: '13:00', desc: '已預約體驗導覽', story: '愛知縣是日本抹茶產量第一，這裡可以體驗石臼磨茶。' },
                        { id: 703, category: '景點', title: '常滑市陶瓷器會館', time: '15:00', desc: '陶瓷器散步道起點', mapcode: '371 791 422*10', story: '常滑燒是日本六古窯之一，散步道沿途有用陶管堆砌的特色牆面。' },
                        { id: 704, category: '景點', title: '守護貓 Tokonyan', desc: '拍照景點', mapcode: '371 790 327*34', story: '巨大的招財貓頭像，從橋上探出頭來，是常滑的地標。' },
                        { id: 705, category: '購物', title: '永旺夢樂城常滑', desc: '最後採買\nAEON Mall', mapcode: '371 759 405*35', story: '距離機場最近的大型購物中心，有巨大的招財貓裝飾。' },
                        { id: 706, category: '租車', title: '還車', time: '20:00', desc: '中部國際機場' },
                        { id: 707, category: '住宿', title: 'Comfort Hotel Central Airport', desc: '機場飯店\n16000點數換房', cost: 2752 }
                    ]
                },
                {
                    date: '1/21', dayOfWeek: 'TUE', location: '名古屋 ➤ 桃園', mainLocationName: '中部國際機場', lat: 34.858, lon: 136.805,
                    items: [
                        { id: 801, category: '航班', title: '返回桃園', subTitle: 'JL8671', time: '12:05 ➤ 14:40' },
                        { id: 802, category: '其他', title: '報到托運', time: '10:00' },
                        { id: 803, category: '美食', title: '蝦仙貝之里', desc: '機場4F', story: '知多半島名產，可以試吃各種口味，是最佳伴手禮。' },
                        { id: 804, category: '景點', title: 'FLIGHT OF DREAMS', desc: '波音787展示', story: '展示第一架波音787原型機，聲光秀非常震撼。' }
                    ]
                }
            ];
    const defaultShopping = [
                { id: 201, region: '名古屋', name: '蓬萊軒 鰻魚飯', price: '', story: '必吃「鰻魚三吃」：一吃原味，二吃加佐料，三吃茶泡飯。' },
                { id: 202, region: '名古屋', name: '矢場味噌豬排', price: '', story: '濃厚赤味噌醬汁淋在剛炸好的豬排上，味道濃郁超下飯。' },
                { id: 203, region: '名古屋', name: '世界的山將 手羽先', price: '', story: '胡椒味重、香辣酥脆的炸雞翅，是名古屋最著名的下酒菜。' },
                { id: 204, region: '名古屋', name: 'Komeda Coffee 小倉吐司', price: '', story: '紅豆泥配上奶油與厚片吐司，名古屋流早餐的經典代表。' },
                { id: 205, region: '托福橫丁', name: '赤福 (Akafuku)', price: '', story: '伊勢名物，紅豆泥包裹麻糬，象徵五十鈴川的清流。保鮮期短需盡快食用。' },
                { id: 206, region: '托福橫丁', name: '伊勢烏龍麵 (Fukusuke)', price: '', story: '麵條極粗且口感軟爛，拌入濃郁黑醬油，是參拜旅人好消化的食物。' },
                { id: 207, region: '托福橫丁', name: '豚捨可樂餅', price: '', story: '使用優質牛肉碎末製作，外酥內嫩，是橫丁最熱門的邊走邊吃美食。' },
                { id: 208, region: '托福橫丁', name: '松阪牛串', price: '', story: '不需花大錢也能品嚐松阪牛美味的入門選擇，油脂香氣迷人。' },
                { id: 209, region: '伊勢志摩', name: '御木本真珠島 珍珠飾品', price: '', story: 'MIKIMOTO品質保證，設計優雅，是送給女性長輩或自用的頂級紀念品。' },
                { id: 210, region: '伊勢志摩', name: '海女小屋 現烤鮑魚/龍蝦', price: '', story: '新鮮捕撈的貝類與伊勢龍蝦，在炭火上現烤，鮮味爆表。' },
                { id: 211, region: '伊勢志摩', name: '伊勢龍蝦仙貝', price: '', story: '使用大量伊勢龍蝦肉泥烘烤，每一口都充滿濃濃海味。' }
    ];
    const defaultInfo = {
        flights: [{id:1,title:'JL8670',desc:'去程 1/14 (二)',startTime:'15:50',startLoc:'TPE T2',endTime:'19:25',endLoc:'NGO T1'},{id:2,title:'JL8671',desc:'回程 1/21 (三)',startTime:'12:05',startLoc:'NGO T1',endTime:'14:40',endLoc:'TPE T2'}],
        hotels: [{id:3,date:'1/14-15',title:'Hotel Castle Inn Tsu',type:'Booking 含早',price:'¥15,496',desc:'兩間客房'},{id:4,date:'1/15-16',title:'志摩観光ホテル ザ ベイスイート',type:'一休 含早',price:'¥92,640',desc:'4名1室'},{id:5,date:'1/16-18',title:'鳥羽国際ホテル 潮路亭',type:'一休 含早',price:'¥142,662',desc:'2名2室 (兩晚)'},{id:6,date:'1/18-20',title:'Comfort Hotel Nagoya Kanayama',type:'CHOICE點數',price:'32000 pts',desc:'兩間客房'},{id:7,date:'1/20-21',title:'Comfort Hotel Central Airport',type:'CHOICE點數',price:'16000 pts',desc:'兩間客房'}],
        rentals: [{id:8,title:'日産レンタカー',subTitle:'中部國際機場店',desc:'取車 1/14 20:00\n還車 1/20 20:00\n車型 Serena e-POWER\n預約號 RC22460954665223760'}]
    };

    createApp({
        setup() {
            // 狀態變數
            const isConnected = ref(false);
            const showConfigAlert = ref(false);
            const currentTab = ref('itinerary');
            const infoSubTab = ref('航班');
            const selectedDateIndex = ref(0);
            const shoppingRegion = ref('全部');
            const isEditMode = ref(false);
            const editIndex = ref(null);
            
            // 資料變數 (預設為空或預設值，等待 Firebase 同步)
            const itineraryData = ref(defaultItinerary);
            const shoppingList = ref(defaultShopping);
            const expenses = ref([]);
            const infoData = ref(defaultInfo);
            const exchangeRate = ref(0.22); // Default exchange rate

            // UI 狀態
            const showAddModal = ref(false);
            const showInfoModal = ref(false);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const showDeleteModal = ref(false);
            const deleteTarget = ref({ id: null, type: null });
            
            const weatherLoading = ref(false);
            const currentWeather = ref({ temp: '--', text: '載入中', code: 0 });

            // 表單模型
            const newItem = ref({ category: '景點', title: '', time: '', desc: '', cost: '', address: '', mapcode: '', story: '' });
            const newInfo = ref({ title: '', desc: '', startTime: '', startLoc: '', endTime: '', endLoc: '', date: '', type: '', price: '', subTitle: '' });
            const newShoppingItem = ref({ id: null, name: '', price: '', address: '', desc: '', region: '名古屋', story: '' }); 
            const newExpense = ref({ id: null, category: '飲食', name: '', amount: '', payment: '現金', date: '', currency: 'JPY' });

            // 初始化 Firebase
            const initFirebase = () => {
                if (!firebaseConfig.apiKey) {
                    showConfigAlert.value = true;
                    // 沒有 Key 時使用預設資料 (已在 ref 定義)
                    return;
                }
                
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    isConnected.value = true;
                    
                    // 監聽資料變更 (Realtime Sync)
                    // 1. 行程
                    onSnapshot(doc(db, "ise_trip", "itinerary"), (doc) => {
                        if (doc.exists()) {
                            itineraryData.value = doc.data().list;
                            syncItineraryToExpenses(); // Sync expenses after itinerary loads
                        }
                        else setDoc(doc.ref, { list: defaultItinerary }); // 初始化
                    });
                    // 2. 必買
                    onSnapshot(doc(db, "ise_trip", "shopping"), (doc) => {
                        if (doc.exists()) shoppingList.value = doc.data().list;
                        else setDoc(doc.ref, { list: defaultShopping });
                    });
                    // 3. 花費
                    onSnapshot(doc(db, "ise_trip", "expenses"), (doc) => {
                        if (doc.exists()) expenses.value = doc.data().list;
                        else setDoc(doc.ref, { list: [] });
                    });
                    // 4. 資訊
                    onSnapshot(doc(db, "ise_trip", "info"), (doc) => {
                        if (doc.exists()) infoData.value = doc.data();
                        else setDoc(doc.ref, defaultInfo);
                    });

                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    alert("Firebase 連線失敗，請檢查 Config");
                }
            };

            // 儲存資料到 Firebase (如果沒連線則無效)
            const saveToFirebase = (collectionName, data) => {
                if (!db) return;
                // 包裝成物件儲存
                const payload = collectionName === 'info' ? data : { list: data };
                updateDoc(doc(db, "ise_trip", collectionName), payload).catch(e => console.error(e));
            };

            // Sync Logic
            const syncItineraryToExpenses = () => {
                let changed = false;
                itineraryData.value.forEach(day => {
                    day.items.forEach(item => {
                        const cost = Number(item.cost);
                        if (cost > 0) {
                            // Check if expense exists for this itinerary item ID
                            // Using a simple check: is there an expense with same ID?
                            // Or better, let's assume we want to add it if it's NOT in expenses list by some logic.
                            // But previous logic added expenses with unique IDs.
                            // To avoid duplicates, let's check if there is an expense with matching name and amount on that date.
                            const exists = expenses.value.some(e => e.date === day.date && e.name === item.title && Number(e.amount) === cost);
                            
                            if (!exists) {
                                expenses.value.push({
                                    id: Date.now() + Math.random(), // Unique ID for expense
                                    date: day.date,
                                    category: item.category || '其他',
                                    name: item.title,
                                    amount: cost,
                                    payment: '現金', // Default
                                    currency: 'JPY'
                                });
                                changed = true;
                            }
                        }
                    });
                });
                if(changed && db) saveToFirebase('expenses', expenses.value);
            };

            // ---- 計算屬性 ----
            const currentDayItinerary = computed(() => itineraryData.value[selectedDateIndex.value].items);
            const currentInfoList = computed(() => {
                if(infoSubTab.value === '航班') return infoData.value.flights;
                if(infoSubTab.value === '住宿') return infoData.value.hotels;
                if(infoSubTab.value === '租車') return infoData.value.rentals;
                return [];
            });
            const filteredShoppingList = computed(() => {
                if (shoppingRegion.value === '全部') return shoppingList.value;
                return shoppingList.value.filter(item => item.region === shoppingRegion.value);
            });
            const expensesByDate = computed(() => {
                const grouped = {};
                const sorted = [...expenses.value].sort((a, b) => a.date.localeCompare(b.date));
                sorted.forEach(item => {
                    if (!grouped[item.date]) grouped[item.date] = [];
                    grouped[item.date].push(item);
                });
                return grouped;
            });
            const expenseStats = computed(() => {
                let totalJPY = 0;
                let totalTWD = 0;
                expenses.value.forEach(e => {
                    const amt = Number(e.amount);
                    if (e.currency === 'TWD') totalTWD += amt;
                    else totalJPY += amt;
                });
                return {
                    jpy: Math.floor(totalJPY),
                    twd: Math.floor(totalTWD),
                    final: Math.floor(totalTWD + (totalJPY * exchangeRate.value))
                };
            });

            // ---- 方法 ----
            const fetchWeather = async () => {
                weatherLoading.value = true;
                const targetDay = itineraryData.value[selectedDateIndex.value];
                if (!targetDay.lat || !targetDay.lon) {
                    currentWeather.value = { temp: '--', text: '無位置資料', code: 0 };
                    weatherLoading.value = false;
                    return;
                }
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${targetDay.lat}&longitude=${targetDay.lon}&current_weather=true`);
                    const data = await res.json();
                    if(data.current_weather) {
                        currentWeather.value = {
                            temp: Math.round(data.current_weather.temperature),
                            text: mapWmoCode(data.current_weather.weathercode),
                            code: data.current_weather.weathercode
                        };
                    }
                } catch (e) {
                    currentWeather.value = { temp: '--', text: '載入失敗', code: 0 };
                } finally {
                    weatherLoading.value = false;
                }
            };

            // CRUD 操作 (修改後會自動呼叫 saveToFirebase)
            const openMap = (query) => {
                if(!query) return;
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            };
            const copyToClipboard = (text) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try { document.execCommand('copy'); alert(`MAPCODE 已複製: ${text}`); } 
                catch (err) {}
                document.body.removeChild(textarea);
            };
            const moveItem = (index, direction) => {
                const items = currentDayItinerary.value;
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < items.length) {
                    [items[index], items[newIndex]] = [items[newIndex], items[index]];
                    saveToFirebase('itinerary', itineraryData.value);
                }
            };
            const requestDelete = (id, type) => {
                deleteTarget.value = { id, type };
                showDeleteModal.value = true;
            };
            const executeDelete = () => {
                const { id, type } = deleteTarget.value;
                if (type === 'itinerary') {
                    const dayItems = itineraryData.value[selectedDateIndex.value].items;
                    const idx = dayItems.findIndex(i => i.id === id);
                    if (idx !== -1) { dayItems.splice(idx, 1); saveToFirebase('itinerary', itineraryData.value); }
                } else if (type === 'info') {
                    let list = null;
                    if (infoSubTab.value === '航班') list = infoData.value.flights;
                    if (infoSubTab.value === '住宿') list = infoData.value.hotels;
                    if (infoSubTab.value === '租車') list = infoData.value.rentals;
                    if(list) { const idx = list.findIndex(i => i.id === id); if(idx !== -1) { list.splice(idx, 1); saveToFirebase('info', infoData.value); } }
                } else if (type === 'shopping') {
                    const idx = shoppingList.value.findIndex(i => i.id === id);
                    if (idx !== -1) { shoppingList.value.splice(idx, 1); saveToFirebase('shopping', shoppingList.value); }
                } else if (type === 'expense') {
                    const idx = expenses.value.findIndex(i => i.id === id);
                    if (idx !== -1) { expenses.value.splice(idx, 1); saveToFirebase('expenses', expenses.value); }
                }
                showDeleteModal.value = false;
            };
            
            const toggleEditMode = () => isEditMode.value = !isEditMode.value;

            // Modal Logic
            const openAddModal = () => {
                editIndex.value = null;
                if (currentTab.value === 'itinerary') {
                    newItem.value = { category: '景點', title: '', time: '', desc: '', cost: '', address: '', mapcode: '', story: '' };
                    showAddModal.value = true;
                } else if (currentTab.value === 'info') {
                    newInfo.value = { title: '', desc: '', startTime: '', startLoc: '', endTime: '', endLoc: '', date: '', type: '', price: '', subTitle: '' };
                    showInfoModal.value = true;
                } else if (currentTab.value === 'shopping') {
                    newShoppingItem.value = { id: null, name: '', price: '', address: '', desc: '', region: shoppingRegion.value === '全部' ? '名古屋' : shoppingRegion.value, story: '' };
                    showShoppingModal.value = true;
                } else if (currentTab.value === 'expense') {
                    // Default to the currently viewed date in itinerary, or the first day
                    const defaultDate = itineraryData.value[selectedDateIndex.value]?.date || itineraryData.value[0].date;
                    newExpense.value = { id: null, category: '飲食', name: '', amount: '', payment: '現金', date: defaultDate, currency: 'JPY' };
                    showExpenseModal.value = true;
                }
            };
            const openEditModal = (item, idx, type) => {
                editIndex.value = idx;
                if (type === 'itinerary') { newItem.value = { ...item }; showAddModal.value = true; }
                else if (type === 'info') { newInfo.value = { ...item }; showInfoModal.value = true; }
                else if (type === 'shopping') { newShoppingItem.value = { ...item }; showShoppingModal.value = true; }
                else if (type === 'expense') { newExpense.value = { ...item }; showExpenseModal.value = true; }
            };

            const saveItineraryItem = () => {
                if (!newItem.value.title) return;
                if (editIndex.value !== null) Object.assign(currentDayItinerary.value[editIndex.value], newItem.value);
                else {
                    const newId = Date.now();
                    currentDayItinerary.value.push({ id: newId, ...newItem.value });
                    if (newItem.value.cost && Number(newItem.value.cost) > 0) {
                        const today = itineraryData.value[selectedDateIndex.value].date;
                        expenses.value.push({ id: Date.now() + 1, category: newItem.value.category || '其他', name: newItem.value.title, amount: Number(newItem.value.cost), payment: '現金', currency: 'JPY', date: today });
                        saveToFirebase('expenses', expenses.value);
                    }
                }
                saveToFirebase('itinerary', itineraryData.value);
                showAddModal.value = false;
            };
            const saveInfoItem = () => {
                if(!newInfo.value.title) return;
                let list = null;
                if(infoSubTab.value === '航班') list = infoData.value.flights;
                if(infoSubTab.value === '住宿') list = infoData.value.hotels;
                if(infoSubTab.value === '租車') list = infoData.value.rentals;
                if(list) {
                    if(editIndex.value !== null) Object.assign(list[editIndex.value], newInfo.value);
                    else list.push({ id: Date.now(), ...newInfo.value });
                    saveToFirebase('info', infoData.value);
                }
                showInfoModal.value = false;
            };
            const saveShoppingItem = () => {
                if(!newShoppingItem.value.name) return;
                if (editIndex.value !== null) {
                    const targetItem = shoppingList.value.find(i => i.id === newShoppingItem.value.id);
                    if(targetItem) Object.assign(targetItem, newShoppingItem.value);
                } else shoppingList.value.push({ id: Date.now(), ...newShoppingItem.value});
                saveToFirebase('shopping', shoppingList.value);
                showShoppingModal.value = false;
            };
            const saveExpense = () => {
                if(!newExpense.value.amount) return;
                if (editIndex.value !== null) {
                    const targetItem = expenses.value.find(i => i.id === newExpense.value.id);
                    if(targetItem) Object.assign(targetItem, newExpense.value);
                } else {
                    // Date is now selectable via dropdown
                    expenses.value.unshift({ 
                        id: Date.now(), 
                        ...newExpense.value 
                    });
                }
                saveToFirebase('expenses', expenses.value);
                showExpenseModal.value = false;
            };
            
            // Watchers and lifecycle
            watch(selectedDateIndex, fetchWeather);
            watch(exchangeRate, (newVal) => {
                localStorage.setItem('ise_exchange_rate', newVal);
            });
            
            onMounted(() => {
                const savedRate = localStorage.getItem('ise_exchange_rate');
                if (savedRate) exchangeRate.value = Number(savedRate);
                
                initFirebase(); // 啟動時連線 Firebase
                fetchWeather();
                
                // If not using Firebase, we might want to run sync here too for local data
                if (!firebaseConfig.apiKey) {
                    syncItineraryToExpenses();
                }
            });

            return {
                currentTab, infoSubTab, selectedDateIndex, shoppingRegion,
                itineraryData, currentDayItinerary, currentInfoList, shoppingList, filteredShoppingList, expenses, expensesByDate,
                showAddModal, showInfoModal, showShoppingModal, showExpenseModal, showDeleteModal,
                newItem, newInfo, newShoppingItem, newExpense, showConfigAlert, isConnected,
                currentWeather, weatherLoading, expenseStats, exchangeRate,
                getWeatherIcon, getCategoryBorderColor, getCategoryBadgeColor, getCategoryIcon,
                openMap, copyToClipboard, moveItem, requestDelete, executeDelete, 
                isEditMode, toggleEditMode, editIndex,
                openAddModal, openEditModal, 
                saveItineraryItem, saveInfoItem, saveShoppingItem, saveExpense
            }
        }
    }).mount('#app');
</script>
</body>
</html>